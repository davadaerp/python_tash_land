<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상가매물 데이터 검색</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.min.css">
    <style>
        /* 전체 페이지 중앙 정렬 */
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 100vh;
          background-color: #f9f9f9;
        }
        h2 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
        }
        /* 검색 컨테이너 스타일 */
        .search-container {
            margin-bottom: 5px;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 95%;
            /*max-width: 1500px;*/
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        .search-input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            position: relative; /* 부모 요소를 relative로 설정: 자동완성시 입력필드 바로아래 오게함.. 중요 */
        }
        .search-input-group label {
          font-weight: bold;
          display: flex;
          align-items: center; /* 수직 가운데 정렬 */
          text-align: left;    /* 텍스트 왼쪽 정렬 */
        }
        .search-input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* 검색 버튼 (아이디로 지정하여 별도 스타일 적용 가능) */
        #search-btn {
          background-color: #007bff; /* 파란색 배경 */
          color: #fff;              /* 흰색 텍스트 */
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          transition: background-color 0.3s ease;
        }
        #search-btn:hover {
          background-color: #0056b3;
        }
        /* 프린트 버튼 스타일 */
        #print-btn {
            padding: 8px 8px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 0px;
        }
        #print-btn:hover {
            background-color: #218838;
        }
        #locatadd_nm {
            flex: 6;
        }
        #aptNm {
            flex: 3;
        }
        #suggestions {
            width: calc(100% - 10px);
            font-family: inherit;
            font-size: inherit;
            list-style: none;
            margin: 0;
            padding: 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            position: absolute;
            top: 100%; /* 입력 필드 바로 아래 */
            left: 0;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #suggestions li {
          padding: 8px;
          cursor: pointer;
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        #suggestions li:hover {
          background-color: #f0f8ff;
        }
        #suggestions li.selected {
          background-color: #007bff;
          color: #fff;
        }
        .filter-group {
          display: flex;
          gap: 15px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
        }
        /*.filter-group label {*/
        /*  font-weight: bold;*/
        /*}*/
        .filter-group select {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
        }
        .filter-group label {
          font-weight: bold;
          display: flex;
          align-items: center; /* 수직 가운데 정렬 */
          text-align: left;    /* 텍스트 왼쪽 정렬 */
        }
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /*select, input {*/
        /*    padding: 10px;*/
        /*    border: 1px solid #ddd;*/
        /*    border-radius: 4px;*/
        /*    font-size: 14px;*/
        /*}*/
        .search-btn {
            padding: 8px 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .search-btn:hover {
            background-color: #0056b3;
        }
        #profit {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          width: 30px; /* mhouseNm의 너비가 약 300px인 경우 1/3 정도 */
          text-align: center;
        }
        /* result-count 를 년도와 비슷하게 스타일 적용 */
        #result-count {
          font-weight: bold;
          padding: 5px;
          border: 1px solid #ddd;
          border-radius: 4px;
          background-color: #fff;
          margin-left: auto;
        }
        /* result-count 를 년도와 비슷하게 스타일 적용 */
        #result-amt {
          font-weight: bold;
          padding: 5px;
          background-color: #fff;
          margin-left: auto;
        }
        /* 테이블 컨테이너 */
        .table-container {
            width: 99%;
            /*max-width: 1300px;*/
            max-height: 990px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            padding: 0px;
            margin-top: 5px; /* 검색창 아래 위치 */
            overflow: auto;
        }
        /* 테이블 헤더 고정 */
        .table-container thead th {
          position: sticky;
          top: 0;
          background-color: #f2f2f2; /* 헤더 배경색, 헤더와 동일하게 */
          z-index: 10; /* 다른 내용보다 위에 표시 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .highlight { color: red; font-weight: bold; }
        .right-align { text-align: right; }
        .center-align { text-align: center; }

        /* 메시지 중앙 정렬 */
        .no-data-message, .loading-message {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin: 50px auto;
        }
        /* 상세 정보 팝업 */
        #detailPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: #fff;
            padding: 20px;
            width: 400px;
            height: 800px;
            border-radius: 8px;
            overflow-y: auto;
            border: 2px solid #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #detailPopup .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        /* Add a style for the selected row */
        #data-container tr.selected {
            background-color: #cce5ff !important; /* A light blue shade */
        }
        #data-container tr.hoverd {
            background-color: #cce5ff !important; /* A light blue shade */
        }

        /* 기존 스타일 유지 및 수정 */
        tbody tr:nth-child(odd) {
          background-color: #ffffff; /* 홀수행: 흰색 */
        }
        tbody tr:nth-child(even) {
          /* background-color: #f0f0f0; /* 짝수행: 연한 회색 */
            background-color: azure;
        }
        tbody tr:hover {
          background-color: #d9d9d9; /* 마우스 오버 시 약간 진한 회색 */
        }

        /* detailPopup 안의 table tr 높이를 1/3로 줄이기 */
        #detailPopup table thead tr th,
        #detailPopup table tbody tr td {
            padding: 2px 8px; /* 패딩 조정으로 높이 축소 */
            font-size: 14px; /* 글자 크기 조정 */
            line-height: 1.2; /* 줄 간격 조정 */
        }
        /* detailPopup 내부의 search-container의 위/아래 마진 제거 */
        #detailPopup .search-container {
          margin-top: 0px !important;
          margin-bottom: 0px !important;
          /* 필요시 패딩도 제거 */
          padding-top: 3px !important;
          padding-bottom: 2px !important;
        }

        /* detailPopup 내부의 filter-group은 flex 컨테이너로 하고, 내부 요소를 양 끝으로 배치 */
        #detailPopup .filter-group {
          display: flex;
          justify-content: space-between;
          align-items: center;
          width: 100%;
          margin: 0 !important;
          padding: 0 !important;
        }

        /* detailPopup 내의 popup-deal 및 popup-auction 영역에서 결과 스팬(right-align 적용) */
        #detailPopup .filter-group #deal-result-amt,
        #detailPopup .filter-group #deal-result-count,
        #detailPopup .filter-group #auction-result-amt,
        #detailPopup .filter-group #auction-result-count {
          margin-left: auto !important;
          text-align: right !important;
          display: inline-block;
          /*font-family: Arial, sans-serif;*/
          font-size: 15px;
          font-weight: bold;
        }

        #popup-rent tr.selected {
            background-color: #cce5ff !important; /* 밝은 파란색 배경 */
            font-weight: bold; /* 글씨를 굵게 */
        }
        #popup-deal tr.selected {
            background-color: #cce5ff !important; /* 밝은 파란색 배경 */
            font-weight: bold; /* 글씨를 굵게 */
        }
        #popup-auction tr.selected {
            background-color: #cce5ff !important; /* 밝은 파란색 배경 */
            font-weight: bold; /* 글씨를 굵게 */
        }

        /* 화면중앙에 메시지 표시 */
        .loading-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: bold;
            color: #333;
            z-index: 1000;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="/static/js/address_autocomplete.js"></script>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/indexed_db_utils.js"></script>
    <script>
        //
        // DOM이 준비되면 window의 load 이벤트로 모든 폼 및 리소스가 완전히 로드될 때 실행합니다.
        window.onload = function() {
            var lawName = "{{ lawName }}";
            var umdNm = "{{ umdNm }}";
            var lawCd = "{{ law_cd }}";
            var apiKey = "{{ api_key }}";
            //alert(lawName + ',' + umdNm + ',' + lawCd);
            // 확장툴실행여부
            if (lawCd && lawCd.trim() !== '') {
                // selectedLawdCd = '4157010900';
                // selectedUmdNm = '구래동';
                selectedLawdCd = lawCd;
                selectedUmdNm = umdNm;
                document.getElementById("locatadd_nm").value = lawName;
                //
                if (apiKey !== '') {
                  localStorage.setItem("sanga_key", apiKey);
                }
                // 0.5초 후 버튼 클릭 이벤트 강제 실행
                setTimeout(() => {
                    document.getElementById("search-btn").click();
                    //document.getElementById("search-btn").dispatchEvent(new Event('click'));
                }, 500);
            }
        };

        $(document).ready(function() {

            // DB생성처리
            openDb(['kland_sanga', 'kland_villa', 'auction_sanga', 'crawl_sanga'])
                .then(db => console.log("모든 스토어 생성 성공"))
                .catch(error => console.error("에러 발생:", error));

            // Attach mouseenter and mouseleave events to rows in #data-container
            $(document).on('mouseenter', '#data-container tr', function () {
                $(this).addClass('hovered');
            });
            $(document).on('mouseleave', '#data-container tr', function () {
                $(this).removeClass('hovered');
            });
            // 거래유형
            document.getElementById("trade_type").addEventListener("change", function () {
                let trade_type = document.getElementById('trade_type').value;
                if (trade_type == '매매') {
                    document.getElementById("sel_floor").selectedIndex = 2; // 상층
                } else {
                    document.getElementById("sel_floor").selectedIndex = 0; // 전체
                }
                applyFilters();
                // 소팅처리
                sortPriceAscending = true;
                $("#sortPyeongPrice").click();
            });
            // select박스 => 물건구분,평,층
            document.querySelectorAll("#pyeon, #sel_floor, #sel_jeonseRate").forEach(function (select) {
                select.addEventListener("change", function () {
                    applyFilters();
                    // 소팅처리
                    // sortPriceAscending = true;
                    // $("#sortPyeongPrice").click();
                });
            });
            //
            $("#profit").on("keyup", applyFilters);
            $("#aptNm").on("keyup", applyFilters);

            $("#profit-link").on("click", openProfitPopup);
            // 프린트 버튼 클릭 이벤트 추가
            $("#print-btn").on("click", printPreview);
            //
            // 체크박스 => 0 제외처리: rent_checkbox, 동일묶은제외: same_price_group_checkbox
            document.querySelectorAll("#same_price_group_checkbox, #rent_checkbox").forEach(function (checkbox) {
                checkbox.addEventListener("click", function () {
                    applyFilters();
                    // 소팅처리
                    sortPriceAscending = true;
                    $("#sortPyeongPrice").click();
                });
            });

            // 거리
            document.getElementById("distance").addEventListener("change", function () {
                let selectedDistance = document.getElementById('distance').value;
                if (selectedDistance == '' || selectedDistance == null || selectedDistance == 'all') {
                    applyFilters();
                }
            });

            // #data-container 내부의 모든 tr에 클릭 이벤트 핸들러 부착
            $("#data-container").on("click", "tr", function () {
                document.querySelectorAll('#data-container tr').forEach(tr => tr.classList.remove('selected'));
                this.closest('tr').classList.add('selected');
                //
                // 먼저 tr에 data-link 속성이 있는지 확인합니다.
                let origIndex = $(this).attr("data-link");
                let selectedItem = window.allFetchedItems[origIndex];
                //console.log(selectedItem);
                // 로우선택시 주변월세 최소/평균/최대 구하기
                //applySelectedRentPrice(selectedItem);
            });
            //

            let sortConfirmDateAscending = false;
            let sortTradeAscending = false;
            let sortCategoryAscending = false;
            let sortFloorAscending = false;
            let sortBuildingAreaAscending = false;
            let sortPriceAscending = false;
            let sortRentPyeongPriceAscending = false;

            // 매물일자 정렬
            $('#sortConfirmDate').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let da = a.confirm_date_str;
                    let db = b.confirm_date_str;
                    return sortConfirmDateAscending ? da.localeCompare(db) : db.localeCompare(da);
                });
                sortConfirmDateAscending = !sortConfirmDateAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // "매매,월세" 정렬
            $('#sortTrade').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let buildingA = a.trade_type ? a.trade_type.toString() : ""; // 문자열 변환 및 예외 처리
                    let buildingB = b.trade_type ? b.trade_type.toString() : "";

                    return sortTradeAscending
                        ? buildingA.localeCompare(buildingB, 'ko-KR')
                        : buildingB.localeCompare(buildingA, 'ko-KR');
                });
                sortTradeAscending = !sortTradeAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 물건구분(일반상가,복합상가,사무실등) 정렬
            $('#sortCategory').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let buildingA = parseInt(a.article_name) || 0;
                    let buildingB = parseInt(b.article_name) || 0;
                    return sortCategoryAscending ? buildingA - buildingB : buildingB - buildingA;
                });
                sortCategoryAscending = !sortCategoryAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // "층" 정렬
            $('#sortFloor').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let buildingA = parseInt(a.cfloor) || 0;
                    let buildingB = parseInt(b.cfloor) || 0;
                    return sortFloorAscending ? buildingA - buildingB : buildingB - buildingA;
                });
                sortFloorAscending = !sortFloorAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 건물평수 정렬
            $('#sortBuildingArea').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let areaA = parseFloat(a.contractPyeong) || 0;
                    let areaB = parseFloat(b.contractPyeong) || 0;
                    return sortBuildingAreaAscending ? areaA - areaB : areaB - areaA;
                });
                sortBuildingAreaAscending = !sortBuildingAreaAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 매각금액 정렬
            $('#sortPrice').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortSalePrice) || 0;
                    let priceB = parseFloat(b.sortSalePrice) || 0;
                    return sortPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortPriceAscending = !sortPriceAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 평단가금액 정렬
            $('#sortPyeongPrice').click(function () {
                const rentCheckbox = document.getElementById("rent_checkbox");
                // rent_checkbox가 체크된 경우 해당 조건에 맞는 항목은 제외한 새로운 배열 생성
                let filteredItems = window.currentFilteredItems.filter(item => {
                    // 문자열 비교 시 trim()을 사용하여 공백 제거
                    if (rentCheckbox && rentCheckbox.checked && item.trade_type.trim() === "매매" && parseInt(item.sale_deposit_price) === 0) {
                        return false;
                    }
                    return true;
                });
                // 정렬
                filteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortPyeongPrice) || 0;
                    let priceB = parseFloat(b.sortPyeongPrice) || 0;
                    return sortPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortPriceAscending = !sortPriceAscending;
                updateSortIcons();
                renderTable(filteredItems);
            });

            // 월세 평단가(매매월세헤더)금액 정렬
            $('#sortRentPyeongPrice').click(function () {
                const rentCheckbox = document.getElementById("rent_checkbox");
                // rent_checkbox가 체크된 경우 해당 조건에 맞는 항목은 제외한 새로운 배열 생성
                let filteredItems = window.currentFilteredItems.filter(item => {
                    // 문자열 비교 시 trim()을 사용하여 공백 제거
                    if (rentCheckbox && rentCheckbox.checked && item.trade_type.trim() === "매매" && parseInt(item.sale_deposit_price) === 0) {
                        return false;
                    }
                    return true;
                });
                // 정렬
                filteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortRentPyeongPrice) || 0;
                    let priceB = parseFloat(b.sortRentPyeongPrice) || 0;
                    return sortRentPyeongPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortRentPyeongPriceAscending = !sortRentPyeongPriceAscending;
                updateSortIcons();
                renderTable(filteredItems);
            });

            function updateSortIcons() {
                $('#sortConfirmDate').text(sortConfirmDateAscending ? '매각일자 ▲' : '매각일자 ▼');
                $('#sortTrade').text(sortTradeAscending ? '거래유형 ▲' : '거래유형 ▼');
                $('#sortCategory').text(sortCategoryAscending ? '아파트명 ▲' : '아파트명 ▼');
                $('#sortFloor').text(sortFloorAscending ? '층 ▲' : '층 ▼');
                $('#sortBuildingArea').text(sortBuildingAreaAscending ? '분양면적(평) ▲' : '분양면적(평) ▼');
                $('#sortPrice').text(sortPriceAscending ? '금액 ▲' : '금액 ▼');
                $('#sortPyeongPrice').text(sortPriceAscending ? '전세금액 ▲' : '전세금액 ▼');
                $('#sortRentPyeongPrice').text(sortRentPyeongPriceAscending ? '매매월세 ▲' : '매매월세 ▼');
            }

            // 월세팝업 버튼 종료 이벤트 리스너 추가
            $('#close-btn').click(function () {
                $("#pyengRentPopup").remove();
                $('#detailPopup').hide();
            });

            // 즐겨찾기 처리
            window.toggleFavorite = function (el) {
                // 현재 상태 가져오기 (on 또는 off)
                var currentState = $(el).data('fav');
                //alert(currentState);
                if (currentState === 'on') {
                    // 즐겨찾기 해제: 이미지 변경 및 data-fav 업데이트
                    $(el).attr('src', '/static/img/star_off.png');
                    $(el).data('fav', 'off');
                    // 서버에 즐겨찾기 해제 상태 전송 (예: AJAX 호출 추가)
                } else {
                    // 즐겨찾기 설정: 이미지 변경 및 data-fav 업데이트
                    $(el).attr('src', '/static/img/star_on.png');
                    $(el).data('fav', 'on');
                    // 서버에 즐겨찾기 설정 상태 전송 (예: AJAX 호출 추가)
                }

                var articleNo = $(el).data('article-no');
                var fav = $(el).data('fav');
                //
                let data = {
                    article_no: articleNo,
                    fav: fav,
                }
                // AJAX로 /api/sanga/fav 호출
                $.ajax({
                    url: BASE_URL + '/api/sanga/fav',
                    method: 'PUT',
                    data: JSON.stringify(data),
                    contentType: "application/json", // JSON 형식임을 명시
                    success: function (response) {
                        // 서버가 jsonify( {"result": "SUCCESS", "message" : "레코드 {article_no} 즐거찾기 수정 완료."})
                        alert(response.message);
                        //console.log(JSON.stringify(response.data));
                        //
                        // window.allFetchedItems 배열에서 해당 article_no를 가진 항목을 찾음
                        var foundItem = window.allFetchedItems.find(item => item.article_no == articleNo);
                        foundItem.fav = fav;
                    },
                    error: function (xhr, status, error) {
                        $('#error-message').text('오류가 발생했습니다: ' + error);
                    }
                });
            }

            // 데이타 검색
            async function fetchData() {
                //
                document.getElementById("result-amt").textContent = "평균금액/단가: 0/0";
                document.getElementById("result-count").textContent = "건수: 0건";
                document.getElementById("aptNm").value = "";
                //
                // 초기화처리
                resetFilters();

                let searchTerm = $('#locatadd_nm').val();
                let trade_type = $('#trade_type').val();
                let saleYear = $('#sale_year').val();           // 사용안함
                let category = '';
                let dangiName = $('#aptNm').val();

                $('#loading').show();
                $('#noData').hide();
                //$('data-container').hide();
                const dataContainer = document.getElementById("data-container");
                dataContainer.innerHTML = "";
                // dataContainer.innerHTML = `<div class="loading-overlay">데이터를 불러오는 중입니다...</div>`;
                $('#loading').hide();

                window.allFetchedItems = [];
                const lawdCd = selectedLawdCd.slice(0,5);
                const umdNm = selectedUmdNm;
                // 크로링되어진 상가데이타 가져오기.
                let storeName = 'crawl_sanga';
                //const exists = await checkDataExists(lawdCd, umdNm, getCurrentDate(), storeName);
                const exists = false;
                if (exists) {
                    window.allFetchedItems = await getAllItems(lawdCd, umdNm, storeName);
                    console.log("데이터가 존재합니다.", window.allFetchedItems);
                } else {
                    $('#errorMessage').hide();
                    $('data-container').hide();
                    try {
                        const data = await $.ajax({
                            url: BASE_URL + '/api/apt',
                            method: 'GET',
                            data: {
                                lawdCd: lawdCd,
                                umdNm: umdNm,
                                searchTerm: searchTerm,
                                trade_type: trade_type,
                                saleYear: saleYear,
                                category: category,
                                dangiName: dangiName
                            },
                            dataType: 'json',
                            timeout: 5000
                        });
                        if (data.length === 0) {
                            $('#noData').show();
                            $('#errorMessage').hide();
                        } else {
                            $('#noData').hide();
                            $('#errorMessage').hide();
                            $('table').show();

                            window.allFetchedItems = data.map((item, i) => ({
                                ...item,
                                originalIndex: i,
                                lawdCD: lawdCd,
                                ymd: getCurrentDate(),
                                umdNm: umdNm
                            }));
                            console.log("데이터가 존재하지 않습니다(IndexedDB입력).=>", storeName);
                            //await addItems(window.allFetchedItems, storeName);
                        }
                    } catch (error) {
                        $('#loading').hide();
                        if (error.statusText === "timeout") {
                            $('#errorMessage').text("서버 응답이 없습니다. 서버가 실행 중인지 확인하세요.").show();
                        } else {
                            $('#errorMessage').text("데이터를 가져오는 중 오류가 발생했습니다: " + error).show();
                        }
                    }
                }
                window.currentFilteredItems = window.allFetchedItems;
                renderTable(window.allFetchedItems);
                // 층수세팅
                set_floor(window.allFetchedItems);
                // 맨처음 매매선택및 상층조회 default
                document.getElementById('trade_type').selectedIndex = 1;
                document.getElementById('trade_type').dispatchEvent(new Event('change'));
            }

            // 초기화처리
            function resetFilters() {

                // 'trade_type' 셀렉트 박스 초기화 (전체 옵션만 남김)
                const selTradeType = document.getElementById("trade_type");
                if (selTradeType) {
                    //selTradeType.innerHTML = '<option value="">전체</option>';
                    selTradeType.selectedIndex = 0;
                }
                //'sel_category' 셀렉트 박스 초기화 (전체 옵션만 남김)
                //document.getElementById("sale_year").selectedIndex = 0;
                document.getElementById("pyeon").selectedIndex = 0;
                document.getElementById("sel_floor").selectedIndex = 0;
            }

            // 층수를 세팅함
            function set_floor(allItems) {
                // sel_floor 셀렉트 박스 초기화 및 중복 없는 층수 옵션 추가
                const selFloorElem = document.getElementById("sel_floor");
                selFloorElem.innerHTML = '<option value="all">전체</option> <option value="low">저층</option> <option value="high">상층</option>';
                let floorSet = new Set();
                allItems.forEach(item => {
                    if (item.cfloor) {
                        floorSet.add(item.cfloor);
                    }
                });
                // 층수 값이 숫자로만 구성되어 있다면 숫자 비교, 그렇지 않으면 문자열 비교로 정렬
                Array.from(floorSet)
                    .sort((a, b) => {
                        let numA = parseFloat(a);
                        let numB = parseFloat(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    })
                    .forEach(floor => {
                        const opt = document.createElement("option");
                        opt.value = floor;
                        opt.textContent = floor + "층";
                        selFloorElem.appendChild(opt);
                    });
            }


            function renderTable(data) {
                let tableBody = $('#data-container');
                tableBody.empty();
                let trade_type = '';
                data.forEach(item => {

                    trade_type = item.trade_type.replace(/\s/g, "");
                    let salePrice = convertKoreanToNumber(item.price);      // 1억 5,000 => 150000000
                    let jeonseMaxPrice = item.jeonseMaxPrice;               //  140000000 => 1억 4,000
                    let pyeongArea = parseFloat(item.exclusive_area_pyeong);
                    // 매매시 해다하는 보증금/월세
                    let saleDepositPrice = convertKoreanToNumber(item.sale_deposit_price);
                    let saleRentPrice = convertKoreanToNumber(item.sale_rent_price);
                    let salesRentPyeongPrice = saleRentPrice === 0 ? 0 : (saleRentPrice / 10000) / pyeongArea;

                    //console.log(trade_type,salePrice,rentPrice,pyeongArea, saleDepositPrice, saleRentPrice);
                    // 평단가 계산(월세는 월세로, 매매는 가격으로)
                    let pyeongPrice =  (salePrice / pyeongArea) / 10000;
                    let priceValue = formatNumber(item.price);
                    let jeonsePriceValue = convertNumberToKorean(jeonseMaxPrice);     // 140000000 => 1억 4,000

                    console.log('' + item.article_name + ' : ' + item.area2 + ' : ' + item.price + ' : salePrice => ' + salePrice + ' : ' + item.jeonseMaxPrice);

                    // 소트용 가격금액, 추정매각금액, 전세금액속성으로 item 객체에 저장
                    item.sortSalePrice = salePrice;
                    item.sortPyeongPrice = jeonseMaxPrice;     // 160000000

                    // 평형조회(m2,전용)
                    const contractPyeong = item.area1 ? (parseFloat(item.area1) / 3.3).toFixed(2) : '';
                    let contractPyeongDisplay = `${item.area1} / <span style="color: red;">${contractPyeong}평</span>`;
                    let pyeongDisplay = `${item.area2} / <span style="color: blue;">${item.exclusive_area_pyeong || ""}</span>`;

                    // 전세율 계산
                    let jeonseRate = 0;
                    if (jeonseMaxPrice > 0) {
                        jeonseRate = ((jeonseMaxPrice / salePrice) * 100).toFixed(2) + '%';
                    } else {
                        jeonseRate = '0%';
                    }

                    // 분양(계약)평형및 전세율 조회
                    item.contractPyeong = contractPyeong;
                    item.jeonseRate = jeonseRate;
                    //
                    tableBody.append(`<tr data-link="${item.originalIndex}">
                        <td class="center-align">
                          <img src="${item.fav === 'on' ? '/static/img/star_on.png' : '/static/img/star_off.png'}"
                               class="favorite-star"
                               data-fav="${item.fav === 'on' ? 'on' : 'off'}"
                               data-article-no="${item.article_no}"
                               style="cursor:pointer; width:17px; height:18px;"
                               onclick="toggleFavorite(this)">
                               ${item.confirm_date_str}
                        </td>
                        <!--
                            <td class="center-align">${item.article_no}</td>
                        -->
                        <td class="center-align">${trade_type}</td>
                        <td class="center-align">${item.article_name}</td>
                        <td class="center-align">${item.buildingName}</td>
                        <td class="center-align">${item.cfloor}</td>
                        <td class="center-align">${item.tfloor}</td>
                        <td class="right-align">${item.direction}</td>
                        <td class="center-align">${contractPyeongDisplay}</td>
                        <td class="center-align">${pyeongDisplay}</td>
                        <td class="right-align" style="color: black;">${priceValue}</td>
                        <td class="right-align" style="color: red;">${jeonsePriceValue}</td>
                        <td class="center-align" style="color: blue;">${jeonseRate}</td>
                        <!--
                        <td class="center-align">
                          ${item.realtor_name.length > 13 ? item.realtor_name.substring(0, 13) + '...' : item.realtor_name}
                        </td>
                        -->
                        <td><button class="map-btn">위치</button></td>
                        <td class="center-align">
                               <button class="detail-btn">상세</button>
                        </td>
                        <td class="center-align">
                               <button class="rent-distance-btn">PIR분석</button>
                        </td>
                    </tr>`);
                });

                // 전체 거래금액과 전체 건물면적(평) 계산
                let totalDealAmount = 0;
                let totalArea = 0;
                let totalPyeongPrice = 0;
                data.forEach(item => {
                    // let amount = Number(item.가격.replace(/,/g, "")) / 10000;
                    let amount = convertKoreanToNumber(item.price) / 10000;
                    totalDealAmount += amount;
                    let area = parseFloat(item.exclusive_area_pyeong);
                    if (!isNaN(area)) {
                        totalArea += area;
                    }
                    // 월세 평단가 누적
                    totalPyeongPrice += item.sortPyeongPrice;
                });

                // 평균금액: 전체 거래금액 / 거래건수
                let avgDealAmount = data.length > 0 ? totalDealAmount / data.length : 0;

                // 평균금액은 한글 형식으로 변환, 평균단가는 천단위 콤마 처리
                let avgDealAmountFormatted = convertToKoreanAmount(avgDealAmount.toFixed(0));

                // result-amt 에 평균금액(총건수 기준) 및 평균단가(평 기준) 출력, result-count 에 건수를 출력
                document.getElementById("result-amt").innerHTML = `평균금액: ${avgDealAmountFormatted}`;
                document.getElementById("result-count").textContent = `건수: ${data.length}`;

                // 매물상세 보기 버튼 이벤트 리스너 추가
                document.querySelectorAll('.detail-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        // Remove the 'selected' class from all rows
                        // document.querySelectorAll('#data-container tr').forEach(tr => tr.classList.remove('selected'));
                        // this.closest('tr').classList.add('selected');
                        //
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        openItemDetailPopup(window.allFetchedItems[origIndex]);
                    });
                });

                // '지도 보기' 버튼에 이벤트 리스너 추가
                document.querySelectorAll('.map-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        // Remove the 'selected' class from all rows
                        // document.querySelectorAll('#data-container tr').forEach(tr => tr.classList.remove('selected'));
                        // this.closest('tr').classList.add('selected');
                        //
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        openMap(window.allFetchedItems[origIndex]);
                    });
                });

                // '상세현황-네이버바로가기' 버튼에 이벤트 리스너 추가
                document.querySelectorAll('.detail-map-direct-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        openMapNaverDetailDirect(window.allFetchedItems[origIndex]);
                    });
                });

                // 현재상가와 가까운 거리에 위지상가 비교및 팝업
                document.querySelectorAll('.rent-distance-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        //
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        if (origIndex === null) {
                            alert("선택된 행의 인덱스를 찾을 수 없습니다.");
                            return;
                        }
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        openRentPricePopup(window.allFetchedItems[origIndex]);
                    });
                });
            }

            // 품목상세내역
            function openItemDetailPopup(item) {
                //
                const article_no = item.article_no;
                var url = "https://fin.land.naver.com/articles/" + article_no;
                var width = 900;
                var height = 1100;

                // 전체 화면 기준 중앙 좌표 계산 (iframe 내부여도 상관없음)
                const left = (screen.width - width) / 2 + 50;
                const top = (screen.height - height) / 2;

                // 새 창 열기 (팝업 창)
                var popupWindow = window.open(url, "popup", `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);

                // 포커스 이동
                if (popupWindow) {
                    popupWindow.focus();
                }
            }

            // 지도위치
            function openMap(item) {
                const article_no = item.article_no;
                var url = "https://m.land.naver.com/near/article/" + article_no + "?poi=SCHOOLPOI";
                var width = 1400;
                var height = 1200;

                // 전체 화면 기준 중앙 좌표 계산 (iframe 내부여도 상관없음)
                const left = (screen.width - width) / 2 + 50;
                const top = (screen.height - height) / 2 - 50;

                // 새 창 열기 (팝업 창)
                var popupWindow = window.open(url, "popup", `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);

                // 포커스 이동
                if (popupWindow) {
                    popupWindow.focus();
                }
            }

            // 네이버 상세창 위치로 바로가기
            function openMapNaverDetailDirect(item) {
                const article_no = item.article_no;
                const latitude = item.latitude;
                const longitute = item.longitude;

                //var url = "https://new.land.naver.com/offices?ms=37.797903,127.1068791,17&a=SG&b=B2&e=RETAIL&articleNo=2513349404";
                var url = "https://new.land.naver.com/offices?ms=" + latitude + "," + longitute + ",17&a=SG&b=B2&e=RETAIL&articleNo=" + article_no;

                        // 새 탭에서 열기
                var newTab = window.open(url, "_blank");

                // 포커스 이동
                if (newTab) {
                    newTab.focus();
                }
            }

            // PIR 팝업목록
            function openRentPricePopup(item) {

                const apt_name = item.article_name; // article_name: 아파트명
                const size = item.area1; // area1: 분양면적, area2: 전용면적
                const salePrice = item.price; // 매매호가   1억 6,000
                const jeonsePrice = convertNumberToKorean(item.jeonseMaxPrice); // 전세호가(최대값) 150000000 => 1억 5,000
                const jeonseRate = item.jeonseRate; // 전세율
                //alert(salePrice + ',' + jeonsePrice + ',' + jeonseRate);
                //callAjax()
                // 아래 ajax를 호출하여 데이타를 가져오게 처리해줘.
                $.ajax({
                    url: '/api/apt/pir_apt',
                    method: 'GET',
                    dataType: 'json',
                    data: {
                        apt_name: apt_name,
                        size: size
                    },
                    success: function(response) {
                        if (response.result === "Fail") {
                            alert("오류가 발생했습니다: " + response.message);
                            return;
                        }
                        // 서버에서 apt_id를 반환한다고 가정
                        // const apt_id = '65078';
                        var apt_id = response.id;
                        const region = response.region_name;
                        const sgg_nm = response.mcode_name
                        let url = BASE_URL + '/api/pastapt/pir?apt_id=' + apt_id + '&region=' + region + '&sgg_nm=' + sgg_nm +
                            '&salePrice=' + salePrice + '&jeonsePrice=' + jeonsePrice + '&jeonseRate=' + jeonseRate;
                        var width = 1400;
                        var height = 1200;
                        const left = (screen.width - width) / 2 + 50;
                        const top = (screen.height - height) / 2 - 50;
                        var popupWindow = window.open(url, "popup", `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
                        if (popupWindow) { popupWindow.focus(); }
                    },
                    error: function(xhr, status, error) {
                        console.error("Ajax 에러:", error);
                    }
                });

                // $('#detailPopup').show();

                // 선택된 아이템을 전역 변수에 저장
                // window.selectedRentItem = item;
                //
                // // 현재 선택로우 위경도를 기준으로 근처에 주변월세목록 가져오기
                // let filteredItems = getRentDistanceFilterItems(item);
                //
                // // 필터링 데이타 월세조회 팝업목록 함수
                // applyRentPricePopupList(filteredItems, item);
                //
                // // 실거래 데이타 팝업목록 함수
                // applyDealPricePopupList(item);
                //
                // // 경매 데이터 팝업 목록 함수 실행
                // applyAuctionPricePopupList(item);
            }


            // 검색 버튼 클릭 이벤트 수정 (입력 체크 추가)
            $('#search-btn').click(function () {
                let searchTerm = $('#locatadd_nm').val().trim(); // 검색어 가져오기
                if (!searchTerm) { // 검색어가 없을 경우 경고 메시지
                    alert("법정동명을 입력하세요.");
                    $('#locatadd_nm').focus(); // 입력란에 포커스 이동
                    return;
                }
                fetchData(); // 검색어가 존재하면 데이터 검색 실행
            });
            //
            //loadYears();

            //=========================================================
            // 조건선택 목록 처리
            function applyFilters() {
                let trade_type = document.getElementById("trade_type").value;
                let aptNm = document.getElementById("aptNm").value;
                //let selYear = document.getElementById("sale_year").value;
                let selPyeon = document.getElementById("pyeon").value;
                let selFloor = document.getElementById("sel_floor").value;
                let selProfit = document.getElementById("profit").value;    // 분양평수입력
                let selJeonseRate = document.getElementById("sel_jeonseRate").value; // 전세율입력

                // 동일그룹묶음(물건구분,층,총층수,전용면적,금액)
                let groupFilteredItems = window.allFetchedItems;
                const same_price_group_checkbox = document.getElementById("same_price_group_checkbox");
                if (same_price_group_checkbox && same_price_group_checkbox.checked) {
                    let seenKeys = new Set();
                    groupFilteredItems = window.allFetchedItems.filter(item => {
                        // 고유 키 생성 (필요에 따라 구분자를 변경하세요)
                        //let key = `${item.article_name}_${item.cfloor}_${item.tfloor}_${item.exclusive_area_pyeong}_${item.price}`;
                        let key = `${item.cfloor}_${item.tfloor}_${item.exclusive_area_pyeong}_${item.price}`;
                        if (seenKeys.has(key)) {
                            return false;
                        } else {
                            seenKeys.add(key);
                            return true;
                        }
                    });
                }
                //=================================
                //
                //filteredItems = window.allFetchedItems.filter(item => {
                let filteredItems = groupFilteredItems.filter(item => {
                    let ok = true;

                    if (trade_type !== "all") {
                        ok = ok && item.trade_type && item.trade_type.includes(trade_type.trim());
                    }
                    if (aptNm !== "") {
                        ok = ok && item.article_name && item.article_name.includes(aptNm.trim());
                    }
                    if (selPyeon !== "all") {
                        let p = Math.floor(parseFloat(item.contractPyeong)); // 소수점 제거 (내림 처리)
                        if (isNaN(p)) return false;
                        if (selPyeon === "9") {
                            ok = ok && (p >= 1 && p < 10);
                        } else if (selPyeon === "10") {
                            ok = ok && (p >= 10 && p < 20);
                        } else if (selPyeon === "20") {
                            ok = ok && (p >= 20 && p < 25);
                        } else if (selPyeon === "25") {
                            ok = ok && (p >= 25 && p < 30);
                        } else if (selPyeon === "30") {
                            ok = ok && (p >= 30 && p < 40);
                        } else if (selPyeon === "40") {
                            ok = ok && (p >= 40 && p < 50);
                        } else if (selPyeon === "50") {
                            ok = ok && (p >= 50 && p < 60);
                        } else if (selPyeon === "60") {
                            ok = ok && (p >= 60 && p < 70);
                        } else if (selPyeon === "70") {
                            ok = ok && (p >= 70 && p < 100);
                        } else if (selPyeon === "100") {
                            ok = ok && (p >= 100);
                        }
                    }

                    // 층수 필터링: 동적 옵션(기본 옵션 제외)에서 선택된 값 기준
                    if (selFloor !== "all") {
                        let p = item.cfloor ? item.cfloor.toString().trim() : ""; // null 방지 + 문자열 변환
                        if (selFloor === "low") {
                            ok = ok && (p === "B1" || p === "B2" || p === "지하" || Number(p) === 1 || Number(p) === 2);
                        } else if (selFloor === "high") {
                            ok = ok && (Number(p) >= 3);
                        } else {
                            if (isNaN(Number(selFloor))) {
                                ok = ok && (p.toString().trim() === selFloor.toString().trim());
                            } else {
                                ok = ok && (Number(p) === Number(selFloor));
                            }
                        }
                    }
                    // 수익율 필터링: 입력된 값이 있는 경우
                    if (selProfit !== "0" && selProfit !== "") {
                        const profitTrim = selProfit.trim();                           // e.g. "24"
                        // '24.14평' → "24.14", '1.24평' → "1.24" 식으로 숫자+소수점만 추출
                        const match = item.contractPyeong && item.contractPyeong.match(/^(\d+(\.\d+)?)/);
                        const numericPart = match ? match[1] : "";                     // e.g. "24.14"
                        // 앞에서부터 profitTrim 길이만큼 잘라서 비교 (여기선 2자리)
                        const prefix = numericPart.substring(0, profitTrim.length);    // e.g. "24"
                        ok = ok && prefix === profitTrim;
                    }

                    // 전세율 필터링: 입력된 값이 있는 경우
                    if (selJeonseRate !== "all") {
                        // 소수점 이하 내림 처리한 정수 전세율 추출 (예: "75.3%" → 75)
                        const rate = Math.floor(parseFloat(item.jeonseRate));
                        if (isNaN(rate)) {
                            ok = false;
                        } else {
                            // seljeonseRate 값에 따라 구간 비교
                            switch (selJeonseRate) {
                                case "100":
                                    // 100% 이상
                                    ok = ok && (rate >= 100);
                                    break;
                                case "90":
                                    ok = ok && (rate >= 90  && rate < 100);
                                    break;
                                case "80":
                                    ok = ok && (rate >= 80  && rate < 90);
                                    break;
                                case "70":
                                    ok = ok && (rate >= 70  && rate < 0);
                                    break;
                                default:
                                    // 정의되지 않은 seljeonseRate 값이 들어오면 필터링에서 제외
                                    ok = false;
                            }
                        }
                    }

                    // 추가 조건: rent_checkbox가 체크되고, 선택된 trade_type이 "매매"인 경우,
                    // item.sale_deposit_price(보증금) 0이면 해당 항목은 필터에서 제외.
                    const rentCheckbox = document.getElementById("rent_checkbox");
                    if (rentCheckbox && rentCheckbox.checked && trade_type === "매매") {
                        // 4번째 필드(jeonseMaxPrice)에서 쉼표 빼고 숫자로 변환
                        const jeonseMaxVal = Number(
                            String(item.jeonseMaxPrice)
                                .replace(/,/g, '')
                                .trim()
                        );
                        // 변환한 값이 0일 때만 제외
                        if (jeonseMaxVal === 0) {
                            ok = false;
                        }
                    }
                    //
                    return ok;
                });
                //
                renderTable(filteredItems);
                window.currentFilteredItems = filteredItems;
            }

            //
            function openProfitPopup() {
                let popup = window.open("/api/menu?menu=sanga_profit", "profitPopup",
                    "resizable=yes, scrollbars=yes, menubar=no, location=no, toolbar=no");

                if (popup) {
                    popup.onload = function () {
                        // let width = popup.document.documentElement.scrollWidth - 500;
                        // let height = popup.document.documentElement.scrollHeight - 370;
                        let width = 980;
                        let height = 850;

                        // 팝업을 현재 화면의 중앙에 배치
                        let left = window.screenX + (window.innerWidth - width) / 2;
                        let top = window.screenY + (window.innerHeight - height) / 2;

                        popup.resizeTo(width, height);
                        popup.moveTo(left, top);
                    };
                } else {
                    alert("팝업이 차단되었습니다. 팝업 차단을 해제해주세요.");
                }
            }

            document.addEventListener("DOMContentLoaded", function () {
                //document.getElementById("profit-link").addEventListener("click", openProfitPopup);

                // 수익율처리 프로세스
                const profitInput = document.getElementById("profit");
                // 입력 시 숫자 외의 문자 제거
                profitInput.addEventListener("input", function () {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            });


            function printPreview() {
                // 인쇄할 영역의 HTML 가져오기
                const searchHTML = document.querySelector(".search-container").outerHTML;
                const dataHTML = document.querySelector(".table-container").outerHTML;

                // 새 창 크기 설정
                const windowWidth = 1350;
                const windowHeight = 1100;

                // 현재 화면 크기를 기반으로 중앙 좌표 계산
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                const left = Math.floor((screenWidth - windowWidth) / 2);
                const top = Math.floor((screenHeight - windowHeight) / 2);

                // 새 창 열기 (창 크기와 위치 지정)
                const printWindow = window.open("", "", `width=${windowWidth},height=${windowHeight},left=${left},top=${top}`);

                // 새 창에 HTML 작성
                printWindow.document.write(`
                <html>
                  <head>
                    <title>프린트 미리보기</title>
                    <style>
                      body { font-family: Arial, sans-serif; padding: 20px; }
                      .search-container, #header-container, #data-container { margin-bottom: 20px; }
                      table { width: 100%; border-collapse: collapse; }
                      th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
                      th { background-color: #f2f2f2; }
                    </style>
                  </head>
                  <body>
                    ${searchHTML}
                    ${dataHTML}
                  </body>
                </html>
              `);
                printWindow.document.close();

                // 새 창 로드 후 500ms 후에 인쇄 명령 실행
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                }, 500);
            }

            // 층,평형으로 필터
            function getFloorAreaFilters(allItems, pgm_type) {
                let selectedFloor = 'all';
                let selectedArea = 'all';
                if (pgm_type === 'rent') {
                    selectedFloor = $("#rent_sel_floor").val();
                    selectedArea = $("#rent_sel_area").val();
                } else if (pgm_type === 'deal') {
                    selectedFloor = $("#deal_sel_floor").val();
                    selectedArea = $("#deal_sel_area").val();
                } else {
                    selectedFloor = $("#auction_sel_floor").val();
                    selectedArea = $("#auction_sel_area").val();
                }
                let filterItems = allItems.filter(item => {
                    let floorOk = true, areaOk = true;
                    if (selectedFloor !== "all") {
                        let p = item.cfloor ? item.cfloor.toString().trim() : "";
                        if (selectedFloor === "low") {
                            let floorNum = parseFloat(p);
                            if (!isNaN(floorNum)) {
                                floorOk = (floorNum <= 2);
                            } else {
                                let lower = p.toLowerCase();
                                floorOk = (lower === "b1" || lower === "b2" || lower.includes("지하"));
                            }
                        } else if (selectedFloor === "high") {
                            let floorNum = parseFloat(p);
                            floorOk = !isNaN(floorNum) ? (floorNum >= 3) : false;
                        } else {
                            let floorNum = parseFloat(p);
                            floorOk = !isNaN(floorNum) ? (floorNum === parseFloat(selectedFloor)) : (p === selectedFloor);
                        }
                    }
                    if (selectedArea !== "all") {
                        let areaVal = parseFloat(item.exclusive_area_pyeong);
                        let groupVal = (areaVal < 10) ? 9 : Math.floor(areaVal / 10) * 10;
                        areaOk = (groupVal == selectedArea);
                    }
                    return floorOk && areaOk;
                });
                return filterItems;
            }

            //================================================
            // 거래데이타 오픈
            function openDealMap(address) {
                const width = 1900;
                const height = 1280;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                // 네이버맵 URL은 "https://map.naver.com/v5/search/" 뒤에 인코딩된 주소를 붙여서 사용합니다.
                window.open('https://map.naver.com/v5/search/' + encodeURIComponent(address), '_blank', 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top);
            }

            //================================================
            function openAuctionMap(address) {
              const width = 1900;
              const height = 1280;
              const left = (screen.width - width) / 2;
              const top = (screen.height - height) / 2;
              // 네이버맵 URL은 "https://map.naver.com/v5/search/" 뒤에 인코딩된 주소를 붙여서 사용합니다.
              window.open('https://map.naver.com/v5/search/' + encodeURIComponent(address), '_blank', 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top);
            }

            // 팝업상에서 바로가기처리
            document.getElementById("map-direct-btn").addEventListener("click", function () {
                openMap(window.selectedRentItem);
            });
            // 팝업상에서 바로가기처리
            document.getElementById("map-detail-direct-btn").addEventListener("click", function () {
                const item = window.selectedRentItem;
                openMapNaverDetailDirect(item);
            });
        });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    </head>
<body>
<h2>아파트매물 데이터 검색(<span id="profit-link" style="color: blue; font-size: 25px; text-decoration: underline; cursor: pointer;">수익율표)</span>
    <input type="hidden" id="api-link">
    </h2>
    <div class="search-container">
        <div class="search-input-group">
            <input type="text" id="locatadd_nm" placeholder="법정동명을 입력하세요">
            <ul id="suggestions"></ul>
            <input type="text" id="aptNm" placeholder="단지명을 입력하세요">
            <!-- 체크박스 추가 -->
            <input type="checkbox" id="same_price_group_checkbox">
            <label for="same_price_group_checkbox">동일묶음,</label>
            <label for="distance">거리:</label>
            <select id="distance">
                <option value="30">30M</option>
                <option value="50">50M</option>
                <option value="70">70M</option>
                <option value="99">100M</option>
                <option value="100">100이상</option>
            </select>
            <button class="search-btn" id="search-btn">검색</button>
            <!-- 프린트 버튼 추가 -->
            <button id="print-btn">프린트</button>
        </div>
        <div class="filter-group">
            <label for="trade_type">거래유형:</label>
            <select id="trade_type">
                <option value="">전체</option>
                <option value="매매">매매</option>
                <option value="전세">전세</option>
                <option value="월세">월세</option>
            </select>
<!--            <label for="sale_year">년:</label>-->
<!--            <select id="sale_year">-->
<!--                <option value="">전체</option>-->
<!--            </select>-->
             <!-- 층수 -->
            <label for="sel_floor">층:</label>
            <select id="sel_floor">
                <option value="all">전체</option>
            </select>
            <label for="pyeon">평형:</label>
            <select id="pyeon">
                <option value="all">전체</option>
                <option value="9">9평대</option>
                <option value="10">10평대</option>
                <option value="20">20평대</option>
                <option value="25">25평대</option>
                <option value="30">30평대</option>
                <option value="40">40평대</option>
                <option value="50">50평대</option>
                <option value="60">60평대</option>
                <option value="70">70평대</option>
                <option value="100">100평대</option>
                <option value="00">기타</option>
            </select>
            <!-- 수익율 -->
            <input type="text" id="profit" value="" placeholder="평형">
            <!-- 전세율 -->
            <label for="sel_jeonseRate">전세율:</label>
            <select id="sel_jeonseRate">
                <option value="all">전체</option>
                <option value="100">100%</option>
                <option value="90">90%</option>
                <option value="80">80%</option>
                <option value="70">80%이하</option>
            </select>
             <!-- 체크박스 추가 -->
            <input type="checkbox" id="rent_checkbox">
            <label for="rent_checkbox">0 전세제외</label>
            <!-- 평규단가 표시 요소 -->
            <span id="result-amt">평균단가/금액: 0/0</span>
            <span id="result-count" style="margin-left: auto;">건수: 0</span>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th id="sortConfirmDate" style="flex:1;">매물일자 ▼</th>
<!--                    <th>기사번호</th>-->
                    <th id="sortTrade" style="flex:1.5;">거래유형 ▼</th>
                    <th id="sortCategory" style="flex:1;">아파트명 ▼</th>
                    <th id="buildingName"   style="flex:0.5;">동</th>
                    <th id="sortFloor" style="flex:0.5;">층수 ▼</th>
                    <th style="flex:0.5;">총층수</th>
                    <th style="flex:1;">방향</th>
                    <th id="sortBuildingArea" style="flex:1;">분양면적(평) ▼</th>
                    <th id="sortBuildingArea2" style="flex:1;">전용면적(평)</th>
                    <th id="sortPrice" style="flex:1;">가격 ▼</th>
                    <th id="sortPyeongPrice" style="flex:1;">전세금액 ▼</th>
                    <th style="flex:1;">전세율</th>
                    <!--
                    <th>중개사명</th>
                    <th style="flex:1;">상세</th>
                    -->
                    <th style="flex:0.5;">위치</th>
                    <th style="flex:1;">상세현황</th>
                    <th style="flex:1;">분석</th>
                </tr>
            </thead>
            <tbody id="data-container"></tbody>
        </table>
        <div id="loading" class="loading-message" style="display: none;">데이터 검색 중입니다...</div>
        <div id="noData" class="no-data-message">데이터를 검색해 주세요.</div>
        <div id="errorMessage" class="error-message" style="display: none; color: red; margin-top: 10px; text-align: center"></div>
    </div>

    <!-- 상세 정보 팝업 -->
    <!-- detailPopup (기존 detailPopup 스타일 수정) -->
    <div id="detailPopup" data-link="0" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:95%; max-width:990px; height:97%; max-height:999px; background:#fff; border:2px solid #007bff; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.2);">
      <!-- 공용 닫기버튼 (우측 상단) -->
      <button id="close-btn" style="position:absolute; top:10px; right:10px; padding:5px 10px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer;  z-index: 9999;">닫기</button>
      <!-- 내부 콘텐츠: flex 컨테이너 (세로배열, 비율 5:3:2) -->
      <div class="popup-content" style="display:flex; flex-direction:column; height:100%;">
        <!-- 월세조회 섹션 (flex:5) -->
        <div id="popup-rent" style="flex:5; overflow:auto; border-bottom:1px solid #ccc; padding:1px;">
          <!-- 월세 Header: 제목 중앙정렬, 오른쪽에 평형분석 버튼 배치 -->
          <div id="rentHeaderTitle" style="position:relative; padding:3px; background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:5px; text-align:left;">
            <h3 style="margin:0; font-size:18px;">월세조회 => <span id="rentDistance">20M</span></h3>
            <div id="rent_selected_item_value" style="margin:9px 0 0; font-size:16px;">
              선택: <span id="monthlyFloor">상층</span>, <span id="monthlyArea">50평</span>,
              <span id="monthlyPrice">가격</span>, @<span id="monthlyUnitPrice">0</span>,
              월세(<span id="monthlyDeposit">0</span>/<span id="monthlyRent">0</span>),
              기준매매가: <span style="color:blue; font-weight:bold;">0</span>
            </div>
            <!-- 캡처 버튼 (왼쪽) -->
            <button id="captuer-btn" style="position:absolute; right:80px; top:70%; transform:translateY(-50%); padding:5px; border:1px solid black; cursor:pointer; font-size:16px;">이미지캡쳐</button>
            <!-- 평형분석 버튼 (오른쪽) -->
            <button id="rent-pyeng-btn" style="position:absolute; right:10px; top:70%; transform:translateY(-50%); padding:5px; border:1px solid black; cursor:pointer; font-size:16px;">평형분석</button>
          </div>
          <!-- 월세 선택부: 좌측에는 필터 그룹 + avgPyeongPriceSpan, 우측에는 동적 데이터 영역 -->
          <div id="monthlyFilters" style="padding:5px; background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:5px; display:flex; justify-content:space-between; align-items:flex-start;">
            <!-- 왼쪽 컬럼: select 및 체크박스, avgPyeongPriceSpan (아래쪽에 배치) -->
            <div id="leftFilters" style="display:flex; flex-direction:column; align-items:flex-start;">
              <div class="filter-group" style="display:flex; align-items:center;">
                    <label for="rent_sel_floor" style="margin-right:1px;">층수:</label>
                    <select id="rent_sel_floor" style="margin-right:5px; padding:8px; border:1px solid #ddd; border-radius:4px;">
                      <option value="all">전체</option>
                      <option value="low">저층</option>
                      <option value="high">상층</option>
                      <!-- 동적 옵션 추가 -->
                    </select>
                    <label for="rent_sel_area" style="margin-right:1px;">평형:</label>
                    <select id="rent_sel_area" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
                      <option value="all">전체</option>
                      <!-- 동적 옵션 추가 -->
                    </select>
                    <input type="checkbox" id="rent_avg_checkbox" style="margin-left:10px;">
                    <label for="rent_avg_checkbox">최대,최소제외</label>
                  <!-- 지도 바로가기 버튼 -->
                  <button id="map-direct-btn" style="margin-left: 10px; padding: 6px 12px; background: #007bff;
                          color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
                          display: inline-block; visibility: visible;">
                    물건위치
                  </button>
                  <button id="map-detail-direct-btn" style="margin-left: 10px; padding: 6px 12px; background: #007bff;
                          color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;
                          display: inline-block; visibility: visible;">
                    상세현황
                  </button>
              </div>
              <div id="avgPyeongPriceSpan" style="margin-top:55px; color:red; font-weight:bold;">
                (평단가: <span style="color:green; font-weight:bold;">0</span> / <span style="color:red; font-weight:bold;">0</span> / <span style="color:blue; font-weight:bold;">0</span>), 평균보증금: <span style="color:green; font-weight:bold;">0 / 0</span>
              </div>
            </div>
            <!-- 오른쪽 컬럼: 동적으로 생성될 층별 데이터 (예: 구분, 최소, 평균, 최대, 건수) -->
            <div id="dynamicRentData" style="width:250px; align-self:center; text-align:right;">
              <!-- updateDynamicRentData() 함수에서 동적으로 채워집니다. -->
            </div>
          </div>
          <!-- 월세 데이터 목록 -->
          <div id="header-container-rent" style="overflow-y:auto; max-height:270px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead style="position:sticky; top:0; background:#f2f2f2; z-index:10;">
                <tr style="border:none;">
                  <th style="width:9%;">순번</th>
                  <th style="width:17%;">물건구분</th>
                  <th style="width:8%;">층</th>
                  <th style="width:9%;">총층수</th>
                  <th style="width:11%;">전용면적</th>
                  <th style="width:16%;">월세</th>
                  <th style="width:13%;">평단가</th>
                    <!--
                  <th style="width:8%;">거리</th>
                  -->
                  <th style="width:17%;">지도</th>
                </tr>
              </thead>
              <!-- 월세 데이터 행들 (동적 생성) -->
              <tbody id="data-container-rent"></tbody>
            </table>
          </div>
        </div>

        <!-- 실거래조회 섹션 (flex:3) - 제공된 기존 코드를 참조 -->
        <div id="popup-deal" style="flex:3; overflow:auto; border-bottom:1px solid #ccc; padding:1px;">
            <div id="search-container-deal" style="position:relative; padding:3px; background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:1px; text-align:left;">
                <div class="filter-group" style="display:flex; justify-content:left; align-items:center;">
                    <label style="margin-right:5px; color: blue;">실거래조회=&gt;</label>
                    <label for="deal_sel_floor" style="margin-right:5px;">층수:</label>
                    <select id="deal_sel_floor" style="margin-right:5px; padding:8px; border:1px solid #ddd; border-radius:4px;">
                    <option value="all">전체</option>
                    <!-- 동적 옵션 추가 -->
                    </select>
                    <label for="deal_sel_area" style="margin-right:5px;">평형:</label>
                    <select id="deal_sel_area" style="margin-right:5px; padding:8px; border:1px solid #ddd; border-radius:4px;">
                        <option value="all">전체</option>
                    </select>
<!--                    <label for="deal_distance">거리:</label>-->
<!--                    <select id="deal_distance">-->
<!--                        <option value="30">30M</option>-->
<!--                        <option value="50">50M</option>-->
<!--                        <option value="70">70M</option>-->
<!--                        <option value="99">100M</option>-->
<!--                        <option value="100">100이상</option>-->
<!--                    </select>-->
                    <span id="deal-result-amt" style="margin-left:10px;">평균단가/금액: 0/0</span>
                    <span id="deal-result-count" style="margin-left:10px;">건수: 0</span>
                    <!-- 평형분석 버튼: Header 오른쪽에 배치 -->
                    <button id="real-pyeng-btn" style="padding:5px; border:1px solid black; cursor:pointer; font-size:15px; margin-right: 10px;">평형분석</button>
                </div>
            </div>
            <div id="header-container-deal" style="overflow-y:auto; max-height:240px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="position:sticky; top:0; background:#f2f2f2; z-index:10;">
                        <tr style="border:none;">
                            <th style="flex:0.5;">순번</th>
                            <th style="flex:1.5;" id="sortDealDate">거래일자</th>
                            <th style="flex:1;" id="sortBuildYear">건축년도</th>
                            <th style="flex:1;" id="sortFloor">층</th>
                            <th style="flex:1.5;" id="sortPyeong">건물면적(평)</th>
                            <th style="flex:1.5;" id="sortPrice">거래금액</th>
                            <th style="flex:1.5;" id="sortPyeongPrice">평단가 ▲</th>
                            <th style="flex:1.5;">건물용도</th>
                            <th style="flex:1;">지도</th>
                        </tr>
                    </thead>
                    <!-- 실거래 데이터 행들 (동적 생성) -->
                    <tbody id="data-container-deal"></tbody>
                </table>
          </div>
        </div>

        <!-- 경매가조회 섹션 (flex:2) - 제공된 기존 코드를 참조 -->
        <div id="popup-auction" style="flex:2.5; overflow:auto; padding:1px;">
          <div id="search-container-auction" style="position:relative; padding:3px; background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:1px; text-align:left;">
            <div class="filter-group" style="display:flex; justify-content:left; align-items:center;">
                <label style="margin-right:5px; color: red;">경매데이타=&gt;</label>
                <label for="auction_sel_floor" style="margin-right:5px;">층수:</label>
                <select id="auction_sel_floor" style="margin-right:5px; padding:8px; border:1px solid #ddd; border-radius:4px;">
                <option value="all">전체</option>
                <!-- 동적 옵션 추가 -->
                </select>
                <label for="auction_sel_area" style="margin-right:5px;">평형:</label>
                <select id="auction_sel_area" style="margin-right:5px; padding:8px; border:1px solid #ddd; border-radius:4px;">
                <option value="all">전체</option>
                </select>
                <span id="auction-result-amt" style="margin-left:10px;">평균단가/금액: 0/0</span>
                <span id="auction-result-count" style="margin-left:10px; margin-right: 90px;">건수: 0</span>
            </div>
          </div>
          <div id="header-container-auction" style="overflow-y:auto; max-height:190px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="position:sticky; top:0; background:#f2f2f2; z-index:10;">
                        <tr style="border:none;">
                            <th style="flex:0.5;">순번</th>
                            <th style="flex:1.5; text-align:center;" id="sortSalesDate">매각일자</th>
                            <th style="flex:1.5; text-align:center;">사건번호</th>
                            <th style="flex:1.5; text-align:center;" id="sortFloor">층</th>
                            <th style="flex:1.5; text-align:center;" id="sortBuildingArea">건물평수</th>
                            <th style="flex:1.5; text-align:center;">감정/최저금액</th>
                            <th style="flex:1.5; text-align:center;" id="sortPrice">매각금액 ▲</th>
                            <th style="flex:1; text-align:center;">평단가</th>
                            <th style="flex:1.5; text-align:center;">건물명</th>
                            <th style="flex:1; text-align:center;">지도</th>
                        </tr>
                    </thead>
                    <!-- 경매 데이터 행들 (동적 생성) -->
                    <tbody id="data-container-auction"></tbody>
                </table>
          </div>
        </div>
      </div>
    </div>
</body>
</html>
