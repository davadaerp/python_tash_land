<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상가매물 데이터 검색</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.min.css">
    <style>
        /* 전체 페이지 중앙 정렬 */
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-height: 100vh;
          background-color: #f9f9f9;
        }
        h2 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
        }
        /* 검색 컨테이너 스타일 */
        .search-container {
            margin-bottom: 5px;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 95%;
            /*max-width: 1500px;*/
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        .search-input-group {
            display: flex;
            gap: 10px;
            width: 100%;
            position: relative; /* 부모 요소를 relative로 설정: 자동완성시 입력필드 바로아래 오게함.. 중요 */
        }
        .search-input-group label {
          font-weight: bold;
          display: flex;
          align-items: center; /* 수직 가운데 정렬 */
          text-align: left;    /* 텍스트 왼쪽 정렬 */
        }
        .search-input-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /* 검색 버튼 (아이디로 지정하여 별도 스타일 적용 가능) */
        #search-btn {
          background-color: #007bff; /* 파란색 배경 */
          color: #fff;              /* 흰색 텍스트 */
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
          transition: background-color 0.3s ease;
        }
        #search-btn:hover {
          background-color: #0056b3;
        }
        /* 프린트 버튼 스타일 */
        #print-btn {
            padding: 8px 8px;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 0px;
        }
        #print-btn:hover {
            background-color: #218838;
        }
        #locatadd_nm {
            flex: 6;
        }
        #aptNm {
            flex: 3;
        }
        #suggestions {
            width: calc(100% - 10px);
            font-family: inherit;
            font-size: inherit;
            list-style: none;
            margin: 0;
            padding: 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            position: absolute;
            top: 100%; /* 입력 필드 바로 아래 */
            left: 0;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #suggestions li {
          padding: 8px;
          cursor: pointer;
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        #suggestions li:hover {
          background-color: #f0f8ff;
        }
        #suggestions li.selected {
          background-color: #007bff;
          color: #fff;
        }
        .filter-group {
          display: flex;
          gap: 15px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
        }
        /*.filter-group label {*/
        /*  font-weight: bold;*/
        /*}*/
        .filter-group select {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
        }
        .filter-group label {
          font-weight: bold;
          display: flex;
          align-items: center; /* 수직 가운데 정렬 */
          text-align: left;    /* 텍스트 왼쪽 정렬 */
        }
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        /*select, input {*/
        /*    padding: 10px;*/
        /*    border: 1px solid #ddd;*/
        /*    border-radius: 4px;*/
        /*    font-size: 14px;*/
        /*}*/
        .search-btn {
            padding: 8px 8px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .search-btn:hover {
            background-color: #0056b3;
        }
        #profit {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          width: 30px; /* mhouseNm의 너비가 약 300px인 경우 1/3 정도 */
          text-align: center;
        }
        #rent_pyeon_price_avg {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          text-align: center;
          display: inline-block;
        }
        /* result-count 를 년도와 비슷하게 스타일 적용 */
        #result-count {
          font-weight: bold;
          padding: 5px;
          border: 1px solid #ddd;
          border-radius: 4px;
          background-color: #fff;
          margin-left: auto;
        }
        /* result-count 를 년도와 비슷하게 스타일 적용 */
        #result-amt {
          font-weight: bold;
          padding: 5px;
          background-color: #fff;
          margin-left: auto;
        }
        /* 테이블 컨테이너 */
        .table-container {
            width: 99%;
            /*max-width: 1300px;*/
            max-height: 990px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            padding: 0px;
            margin-top: 5px; /* 검색창 아래 위치 */
            overflow: auto;
        }
        /* 테이블 헤더 고정 */
        .table-container thead th {
          position: sticky;
          top: 0;
          background-color: #f2f2f2; /* 헤더 배경색, 헤더와 동일하게 */
          z-index: 10; /* 다른 내용보다 위에 표시 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            font-size: 14px;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .highlight { color: red; font-weight: bold; }
        .right-align { text-align: right; }
        .center-align { text-align: center; }

        /* 메시지 중앙 정렬 */
        .no-data-message, .loading-message {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin: 50px auto;
        }
        /* 상세 정보 팝업 */
        #detailPopup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: #fff;
            padding: 20px;
            width: 400px;
            height: 700px;
            border-radius: 8px;
            overflow-y: auto;
            border: 2px solid #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #detailPopup .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        /* Add a style for the selected row */
        #data-container tr.selected {
            background-color: #cce5ff !important; /* A light blue shade */
        }
        #data-container tr.hoverd {
            background-color: #cce5ff !important; /* A light blue shade */
        }

        /* 기존 스타일 유지 및 수정 */
        tbody tr:nth-child(odd) {
          background-color: #ffffff; /* 홀수행: 흰색 */
        }
        tbody tr:nth-child(even) {
          /* background-color: #f0f0f0; /* 짝수행: 연한 회색 */
            background-color: azure;
        }
        tbody tr:hover {
          background-color: #d9d9d9; /* 마우스 오버 시 약간 진한 회색 */
        }
    </style>
    <script src="/static/js/address_autocomplete.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        //
        $(document).ready(function() {

            // Attach mouseenter and mouseleave events to rows in #data-container
            $(document).on('mouseenter', '#data-container tr', function() {
                $(this).addClass('hovered');
            });
            $(document).on('mouseleave', '#data-container tr', function() {
                $(this).removeClass('hovered');
            });
            // 거래유형
            document.getElementById("trade_type").addEventListener("change", function() {
                let trade_type = document.getElementById('trade_type').value;
                if (trade_type == '매매') {
                    document.getElementById("sel_floor").selectedIndex = 2; // 상층
                } else {
                    document.getElementById("sel_floor").selectedIndex = 0; // 전체
                }
                 applyFilters();
                // 소팅처리
                sortPriceAscending = true;
                $("#sortPyeongPrice").click();
            });
            // select박스 => 물건구분,평,층
            document.querySelectorAll("#category, #pyeon, #sel_floor").forEach(function(select) {
                select.addEventListener("change", function() {
                    applyFilters();
                    // 소팅처리
                    sortPriceAscending = true;
                    $("#sortPyeongPrice").click();
                });
            });
            //
            $("#profit").on("keyup", applyFilters);
            $("#profit-link").on("click", openProfitPopup);
            // 프린트 버튼 클릭 이벤트 추가
            $("#print-btn").on("click", printPreview);
            //
            // 체크박스 => 0 제외처리: rent_checkbox, 동일묶은제외: same_price_group_checkbox
            document.querySelectorAll("#same_price_group_checkbox, #rent_checkbox").forEach(function(checkbox) {
                checkbox.addEventListener("click", function() {
                    applyFilters();
                    // 소팅처리
                    sortPriceAscending = true;
                    $("#sortPyeongPrice").click();
                });
            });
            // 평형별분석
            document.getElementById("pyeon-btn").addEventListener("click", function() {
                pyengPopupView(null);
            });
            // 거리
            document.getElementById("distance").addEventListener("change", function() {
                let selectedDistance = document.getElementById('distance').value;
                if (selectedDistance == '' || selectedDistance == null || selectedDistance == 'all') {
                    applyFilters();
                }
            });

            // #data-container 내부의 모든 tr에 클릭 이벤트 핸들러 부착
            $("#data-container").on("click", "tr", function() {
                document.querySelectorAll('#data-container tr').forEach(tr => tr.classList.remove('selected'));
                this.closest('tr').classList.add('selected');
                //
                // 먼저 tr에 data-link 속성이 있는지 확인합니다.
                let origIndex = $(this).attr("data-link");
                let selectedItem = window.allFetchedItems[origIndex];
                //console.log(selectedItem);
                // 로우선택시 주변월세 최소/평균/최대 구하기
                applySelectedRentPrice(selectedItem);
            });
            //

            let sortConfirmDateAscending = false;
            let sortTradeAscending = false;
            let sortCategoryAscending = false;
            let sortFloorAscending = false;
            let sortBuildingAreaAscending = false;
            let sortPriceAscending = false;
            let sortRentPyeongPriceAscending = false;

            // 매물일자 정렬
            $('#sortConfirmDate').click(function() {
                window.currentFilteredItems.sort((a, b) => {
                    let da = a.confirm_date_str;
                    let db = b.confirm_date_str;
                    return sortConfirmDateAscending ? da.localeCompare(db) : db.localeCompare(da);
                });
                sortConfirmDateAscending = !sortConfirmDateAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // "매매,월세" 정렬
            $('#sortTrade').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let buildingA = a.trade_type ? a.trade_type.toString() : ""; // 문자열 변환 및 예외 처리
                    let buildingB = b.trade_type ? b.trade_type.toString() : "";

                    return sortTradeAscending
                        ? buildingA.localeCompare(buildingB, 'ko-KR')
                        : buildingB.localeCompare(buildingA, 'ko-KR');
                });
                sortTradeAscending = !sortTradeAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 물건구분(일반상가,복합상가,사무실등) 정렬
            $('#sortCategory').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let buildingA = parseInt(a.article_name) || 0;
                    let buildingB = parseInt(b.article_name) || 0;
                    return sortCategoryAscending ? buildingA - buildingB : buildingB - buildingA;
                });
                sortCategoryAscending = !sortCategoryAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // "층" 정렬
            $('#sortFloor').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let buildingA = parseInt(a.cfloor) || 0;
                    let buildingB = parseInt(b.cfloor) || 0;
                    return sortFloorAscending ? buildingA - buildingB : buildingB - buildingA;
                });
                sortFloorAscending = !sortFloorAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 건물평수 정렬
            $('#sortBuildingArea').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let areaA = parseFloat(a.exclusive_area_pyeong) || 0;
                    let areaB = parseFloat(b.exclusive_area_pyeong) || 0;
                    return sortBuildingAreaAscending ? areaA - areaB : areaB - areaA;
                });
                sortBuildingAreaAscending = !sortBuildingAreaAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 매각금액 정렬
            $('#sortPrice').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortSalePrice) || 0;
                    let priceB = parseFloat(b.sortSalePrice) || 0;
                    return sortPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortPriceAscending = !sortPriceAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            // 평단가금액 정렬
            $('#sortPyeongPrice').click(function () {
                const rentCheckbox = document.getElementById("rent_checkbox");
                // rent_checkbox가 체크된 경우 해당 조건에 맞는 항목은 제외한 새로운 배열 생성
                let filteredItems = window.currentFilteredItems.filter(item => {
                    // 문자열 비교 시 trim()을 사용하여 공백 제거
                    if (rentCheckbox && rentCheckbox.checked && item.trade_type.trim() === "매매" && parseInt(item.sale_deposit_price) === 0) {
                        return false;
                    }
                    return true;
                });
                // 정렬
                filteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortPyeongPrice) || 0;
                    let priceB = parseFloat(b.sortPyeongPrice) || 0;
                    return sortPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortPriceAscending = !sortPriceAscending;
                updateSortIcons();
                renderTable(filteredItems);
            });

            // 월세 평단가(매매월세헤더)금액 정렬
            $('#sortRentPyeongPrice').click(function () {
                const rentCheckbox = document.getElementById("rent_checkbox");
                // rent_checkbox가 체크된 경우 해당 조건에 맞는 항목은 제외한 새로운 배열 생성
                let filteredItems = window.currentFilteredItems.filter(item => {
                    // 문자열 비교 시 trim()을 사용하여 공백 제거
                    if (rentCheckbox && rentCheckbox.checked && item.trade_type.trim() === "매매" && parseInt(item.sale_deposit_price) === 0) {
                        return false;
                    }
                    return true;
                });
                // 정렬
                filteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortRentPyeongPrice) || 0;
                    let priceB = parseFloat(b.sortRentPyeongPrice) || 0;
                    return sortRentPyeongPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortRentPyeongPriceAscending = !sortRentPyeongPriceAscending;
                updateSortIcons();
                renderTable(filteredItems);
            });

            // 추후매각금액 정렬
            $('#sortProfitPrice').click(function () {
                window.currentFilteredItems.sort((a, b) => {
                    let priceA = parseFloat(a.sortProfitSalePrice) || 0;
                    let priceB = parseFloat(b.sortProfitSalePrice) || 0;
                    return sortPriceAscending ? priceA - priceB : priceB - priceA;
                });
                sortPriceAscending = !sortPriceAscending;
                updateSortIcons();
                renderTable(window.currentFilteredItems);
            });

            function updateSortIcons() {
                $('#sortConfirmDate').text(sortConfirmDateAscending ? '매각일자 ▲' : '매각일자 ▼');
                $('#sortTrade').text(sortTradeAscending ? '거래유형 ▲' : '거래유형 ▼');
                $('#sortCategory').text(sortCategoryAscending ? '물건구분 ▲' : '물건구분 ▼');
                $('#sortFloor').text(sortFloorAscending ? '층 ▲' : '층 ▼');
                $('#sortBuildingArea').text(sortBuildingAreaAscending ? '전용면적(평) ▲' : '전용면적(평) ▼');
                $('#sortPrice').text(sortPriceAscending ? '금액 ▲' : '금액 ▼');
                $('#sortPyeongPrice').text(sortPriceAscending ? '평단가 ▲' : '평단가 ▼');
                $('#sortRentPyeongPrice').text(sortRentPyeongPriceAscending ? '매매월세 ▲' : '매매월세 ▼');
                $('#sortProfitPrice').text(sortPriceAscending ? '월세매매가 ▲' : '월세매매가 ▼');
            }

            // 즐겨찾기 처리
            window.toggleFavorite = function(el) {
              // 현재 상태 가져오기 (on 또는 off)
              var currentState = $(el).data('fav');
              //alert(currentState);
              if (currentState === 'on') {
                // 즐겨찾기 해제: 이미지 변경 및 data-fav 업데이트
                $(el).attr('src', '/static/img/star_off.png');
                $(el).data('fav', 'off');
                // 서버에 즐겨찾기 해제 상태 전송 (예: AJAX 호출 추가)
              } else {
                // 즐겨찾기 설정: 이미지 변경 및 data-fav 업데이트
                $(el).attr('src', '/static/img/star_on.png');
                $(el).data('fav', 'on');
                // 서버에 즐겨찾기 설정 상태 전송 (예: AJAX 호출 추가)
              }

              var articleNo = $(el).data('article-no');
              var fav = $(el).data('fav');
              //
              let data = {
                  article_no: articleNo,
                  fav: fav,
              }
              // AJAX로 /api/sanga/fav 호출
              $.ajax({
                    url: BASE_URL + '/api/sanga/fav',
                    method: 'PUT',
                    data: JSON.stringify(data),
                    contentType: "application/json", // JSON 형식임을 명시
                    success: function(response) {
                        // 서버가 jsonify( {"result": "SUCCESS", "message" : "레코드 {article_no} 즐거찾기 수정 완료."})
                        alert(response.message);
                        //console.log(JSON.stringify(response.data));
                        //
                        // window.allFetchedItems 배열에서 해당 article_no를 가진 항목을 찾음
                        var foundItem = window.allFetchedItems.find(item => item.article_no == articleNo);
                        foundItem.fav = fav;
                    },
                    error: function(xhr, status, error) {
                      $('#error-message').text('오류가 발생했습니다: ' + error);
                    }
              });
            }

            // 데이타 검색
            function fetchData() {
                //
                document.getElementById("result-amt").textContent = "평균금액/단가: 0/0";
                document.getElementById("result-count").textContent = "건수: 0건";
                document.getElementById("aptNm").value = "";
                //
                // 초기화처리
                resetFilters();

                let searchTerm = $('#locatadd_nm').val();
                let trade_type = $('#trade_type').val();
                let saleYear = $('#sale_year').val();           // 사용안함
                let category = '';
                let dangiName = $('#aptNm').val();

                $('#loading').show();
                $('#noData').hide();
                $('data-container').hide();

                $.ajax({
                    url: BASE_URL + '/api/sanga',
                    method: 'GET',
                    data: {
                        lawdCd: selectedLawdCd,
                        umdNm: selectedUmdNm,
                        searchTerm: searchTerm,
                        trade_type: trade_type,
                        saleYear: saleYear,
                        category: category,
                        dangiName: dangiName
                    },
                    dataType: 'json',
                    timeout: 5000,  // 5초 타임아웃 설정
                    beforeSend: function () {
                        $('#loading').show();
                        $('#noData').hide();
                        $('#errorMessage').hide();  // 에러 메시지 초기화
                        $('data-container').hide();
                    },
                    success: function (data) {
                        $('#loading').hide();
                        if (data.length === 0) {
                            $('#noData').show();
                            $('#errorMessage').hide(); // 오류 메시지가 보이지 않도록 설정
                        } else {
                            $('#noData').hide();
                            $('#errorMessage').hide();
                            $('table').show();
                            // 원본 인덱스를 각 항목에 추가
                            window.allFetchedItems = data.map((item, i) => {
                                item.originalIndex = i;
                                return item;
                            });
                            window.currentFilteredItems = window.allFetchedItems ;
                            renderTable(window.allFetchedItems);
                            // 층수세팅
                            set_floor(data);
                            //
                            // 필터후 맴처음 레코드 셀렉트 월세평균금액 처리: 로우선택시 주변월세 최소/평균/최대 구하기
                            let selectedItem = window.currentFilteredItems[0];
                            applySelectedRentPrice(selectedItem);
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#loading').hide();
                        if (status === "timeout") {
                            $('#errorMessage').text("서버 응답이 없습니다. 서버가 실행 중인지 확인하세요.").show();
                        } else {
                            $('#errorMessage').text("데이터를 가져오는 중 오류가 발생했습니다: " + error).show();
                        }
                    }
                });
            }

            // 초기화처리
            function resetFilters() {

                // 'trade_type' 셀렉트 박스 초기화 (전체 옵션만 남김)
                const selTradeType = document.getElementById("trade_type");
                if (selTradeType) {
                    //selTradeType.innerHTML = '<option value="">전체</option>';
                    selTradeType.selectedIndex = 0;
                }
                //'sel_category' 셀렉트 박스 초기화 (전체 옵션만 남김)
                //document.getElementById("sale_year").selectedIndex = 0;
                document.getElementById("category").selectedIndex = 0;
                document.getElementById("pyeon").selectedIndex = 0;
                document.getElementById("sel_floor").selectedIndex = 0;
            }

            // 층수를 세팅함
            function set_floor(allItems) {
                // sel_floor 셀렉트 박스 초기화 및 중복 없는 층수 옵션 추가
                const selFloorElem = document.getElementById("sel_floor");
                selFloorElem.innerHTML = '<option value="all">전체</option> <option value="low">저층</option> <option value="high">상층</option>';
                let floorSet = new Set();
                allItems.forEach(item => {
                    if (item.cfloor) {
                        floorSet.add(item.cfloor);
                    }
                });
                // 층수 값이 숫자로만 구성되어 있다면 숫자 비교, 그렇지 않으면 문자열 비교로 정렬
                Array.from(floorSet)
                    .sort((a, b) => {
                        let numA = parseFloat(a);
                        let numB = parseFloat(b);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    })
                  .forEach(floor => {
                    const opt = document.createElement("option");
                    opt.value = floor;
                    opt.textContent = floor + "층";
                    selFloorElem.appendChild(opt);
                  });
            }

            // 월세평균값 가져오기
            function getRentPyengPriceAvgMiddleValue() {
              const spanEl = document.getElementById("rent_pyeon_price_avg");
              if (spanEl) {
                // 예: "0/ 0 /0" → 분할
                const parts = spanEl.textContent.split("/");
                if (parts.length >= 3) {
                  // 가운데 값 (인덱스 1)을 trim()으로 공백 제거
                  const middleValue = parts[1].trim();
                  console.log("가운데 값:", middleValue);
                  return middleValue;
                }
              }
              return 0;
            }

            function renderTable(data) {
                let tableBody = $('#data-container');
                tableBody.empty();
                let trade_type = '';
                data.forEach(item => {
                    trade_type = item.trade_type.replace(/\s/g, "");
                    let salePrice = convertKoreanToNumber(item.price);
                    let rentPrice = convertKoreanToNumber(item.rentPrc);
                    let pyeongArea = parseFloat(item.exclusive_area_pyeong);
                    // 매매시 해다하는 보증금/월세
                    let saleDepositPrice = convertKoreanToNumber(item.sale_deposit_price);
                    let saleRentPrice = convertKoreanToNumber(item.sale_rent_price);
                    let salesRentPyeongPrice = saleRentPrice === 0 ? 0 : (saleRentPrice / 10000) / pyeongArea;

                    //console.log(trade_type,salePrice,rentPrice,pyeongArea, saleDepositPrice, saleRentPrice);
                    // 평단가 계산(월세는 월세로, 매매는 가격으로)
                    let pyeongPrice = 0;
                    let priceValue = '';
                    if (trade_type == '매매') {
                        pyeongPrice=  (salePrice / pyeongArea) / 10000;
                        priceValue = formatNumber(item.price);
                    } else {
                        pyeongPrice= (rentPrice / pyeongArea) / 10000;
                        priceValue = formatNumber(item.price) + '/' + '<span style="color: green;">' + formatNumber(item.rentPrc) + '</span>';
                    }
                    // 수익율계산하기
                    const profit = Number(document.getElementById('profit').value.replace(/[^0-9]/g, ''));
                    let sortProfitSalePrice = 0;
                    let profitSaleAmt = 0;          // 매매적용되어진 월세기준 수익율매매가.
                    let profitRentAvgSaleAmt = 0;   // 월세평균적용되어진 수익율매매가.
                    let profitPercent = (profit / 100);
                    if (profit == 6) {
                        //profitPercent = 200;
                    }
                    // 수익율매매가
                    if (trade_type == '월세') {
                        // 보증금 3000 => 30000000
                        let calcProfitSaleAmt = (rentPrice * 12) / profitPercent.toFixed(3);
                        // 단위 변환: 원 → 만원 (1만원 = 10,000원)
                        calcProfitSaleAmt = (calcProfitSaleAmt + salePrice) / 10000;
                        // 만원 단위의 숫자를 문자열로 변환 (함수 내부에서 콤마 제거 작업을 하고 있으므로)
                        profitSaleAmt = convertToKoreanAmount(calcProfitSaleAmt.toString());
                    } else {
                         // 매매추정가 = 월세 * 12 * 수익율 + 보증금
                         let calcProfitSaleAmt = (saleRentPrice * 12) / profitPercent.toFixed(3);
                         let compProfitSaleAmt = calcProfitSaleAmt + saleDepositPrice;

                        // 단위 변환: 원 → 만원 (1만원 = 10,000원)
                        calcProfitSaleAmt = compProfitSaleAmt / 10000;
                        sortProfitSalePrice = calcProfitSaleAmt;

                        // 나온매물과 추정매매가 비교처리
                        if (compProfitSaleAmt > salePrice) {
                            // 만원 단위의 숫자를 문자열로 변환 (함수 내부에서 콤마 제거 작업을 하고 있으므로)
                            profitSaleAmt = '<span style="color: red; font-weight: bold;">' + convertToKoreanAmount(calcProfitSaleAmt.toString()) + '</span>';
                        } else {
                            // 만원 단위의 숫자를 문자열로 변환 (함수 내부에서 콤마 제거 작업을 하고 있으므로)
                            profitSaleAmt = convertToKoreanAmount(calcProfitSaleAmt.toString());
                        }
                        //
                        // 월세평균금액으로 매매금액 산정
                        // let rent_pyeon_price_avg = getRentPyengPriceAvgMiddleValue();
                        // let rentPyeonPriceAvg = parseFloat(rent_pyeon_price_avg) * 10000;
                        // // 평균단가 * 전용평수(반올림) * 12 + 보등금
                        // let calcProfitRentAvgSaleAmt = (rentPyeonPriceAvg * Math.round(pyeongArea) * 12) / profitPercent.toFixed(3);
                        // let compProfitRentAvgSaleAmt = calcProfitRentAvgSaleAmt + saleDepositPrice;
                        //
                        // // 단위 변환: 원 → 만원 (1만원 = 10,000원)
                        // calcProfitRentAvgSaleAmt = compProfitRentAvgSaleAmt / 10000;
                        // // 만원 단위의 숫자를 문자열로 변환 (함수 내부에서 콤마 제거 작업을 하고 있으므로)
                        // profitRentAvgSaleAmt = profitSaleAmt == 0 ? 0 : '<span style="color: green; font-weight: bold;">' + convertToKoreanAmount(calcProfitRentAvgSaleAmt.toString()) + '</span>';
                        profitRentAvgSaleAmt = '<span style="color: green; font-weight: bold;">0</span>';
                    }
                    // 소트용 가격금액, 추정매각금액, 평단가속성으로 item 객체에 저장
                    item.sortSalePrice = salePrice;
                    item.sortProfitSalePrice = sortProfitSalePrice;
                    item.sortPyeongPrice = pyeongPrice;
                    // 매매에서 월세평단가
                    item.sortRentPyeongPrice = salesRentPyeongPrice;

                    //console.log(pyeongAmt, pyeongArea, pyeongPrice)

                    // 평형조회(m2,전용)
                    let pyeongDisplay = `${item.area2} / <span style="color: blue;">${item.exclusive_area_pyeong || ""}</span>`;

                    tableBody.append(`<tr data-link="${item.originalIndex}">
                        <td class="center-align">
                          <img src="${item.fav === 'on' ? '/static/img/star_on.png' : '/static/img/star_off.png'}"
                               class="favorite-star"
                               data-fav="${item.fav === 'on' ? 'on' : 'off'}"
                               data-article-no="${item.article_no}"
                               style="cursor:pointer; width:17px; height:18px;"
                               onclick="toggleFavorite(this)">
                               ${item.confirm_date_str}
                        </td>
                        <!--
                            <td class="center-align">${item.article_no}</td>
                        -->
                        <td class="center-align">${trade_type}</td>
                        <td class="center-align">${item.article_name}</td>
                        <td class="center-align">${item.cfloor}</td>
                        <td class="center-align">${item.tfloor}</td>
                        <td class="right-align">${item.direction}</td>
                        <td class="center-align">${pyeongDisplay}</td>
                        <td class="right-align" style="color: black;">${priceValue}</td>
                        <td class="right-align" style="color: red;">@${trade_type == '매매' ? formatNumber(pyeongPrice.toFixed(0)) + '만' : formatNumber(pyeongPrice.toFixed(1)) + '만'}</td>
                        <td class="center-align" style="color: green;">${trade_type == '매매' ? item.sale_deposit_price + '/' + item.sale_rent_price +  '<span style="color: red;"> @' + salesRentPyeongPrice.toFixed(1) + '</span>': 0} </td>
                        <td class="center-align" style="color: blue;">${profitSaleAmt}</td>
                        <!--
                        <td class="center-align">
                          ${item.realtor_name.length > 13 ? item.realtor_name.substring(0, 13) + '...' : item.realtor_name}
                        </td>
                        -->
                        <td><button class="map-btn">위치</button></td>
                        <td class="center-align">
                               <button class="detail-btn">상세</button>
                        </td>
                        <td class="center-align">
                               <button class="rent-distance-btn">주변월세</button>
                        </td>
                    </tr>`);
                });

                // 전체 거래금액과 전체 건물면적(평) 계산
                let totalDealAmount = 0;
                let totalArea = 0;
                let totalPyeongPrice = 0;
                data.forEach(item => {
                    // let amount = Number(item.가격.replace(/,/g, "")) / 10000;
                    let amount = convertKoreanToNumber(item.price) / 10000;
                    totalDealAmount += amount;
                    let area = parseFloat(item.exclusive_area_pyeong);
                    if (!isNaN(area)) {
                        totalArea += area;
                    }
                    // 월세 평단가 누적
                    totalPyeongPrice += item.sortPyeongPrice;
                });

                // 평균금액: 전체 거래금액 / 거래건수
                let avgDealAmount = data.length > 0 ? totalDealAmount / data.length : 0;

                // 매매평균단가: 전체 거래금액 / 전체 건물면적(평), 월세평균단가
                let avgUnitPrice= totalPyeongPrice / data.length;
                /*
                if (trade_type == '매매') {
                    //avgUnitPrice = totalArea > 0 ? totalDealAmount / totalArea : 0;
                    avgUnitPrice = totalPyeongPrice / data.length;
                } else {
                    avgUnitPrice = totalPyeongPrice / data.length;
                }
                 */
                // 평균금액은 한글 형식으로 변환, 평균단가는 천단위 콤마 처리
                let avgDealAmountFormatted = convertToKoreanAmount(avgDealAmount.toFixed(0));
                let avgUnitPriceFormatted = trade_type == '매매' ? formatNumber(avgUnitPrice.toFixed(0)) : formatNumber(avgUnitPrice.toFixed(1));

                // result-amt 에 평균금액(총건수 기준) 및 평균단가(평 기준) 출력, result-count 에 건수를 출력
                document.getElementById("result-amt").innerHTML = `평균금액/단가: ${avgDealAmountFormatted}/<span style="color: red;">@${avgUnitPriceFormatted}</span>`;
                document.getElementById("result-count").textContent = `건수: ${data.length}`;

                // 매물상세 보기 버튼 이벤트 리스너 추가
                document.querySelectorAll('.detail-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        // Remove the 'selected' class from all rows
                        // document.querySelectorAll('#data-container tr').forEach(tr => tr.classList.remove('selected'));
                        // this.closest('tr').classList.add('selected');
                        //
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        openDetailPopup(window.allFetchedItems[origIndex]);
                    });
                });

                // '지도 보기' 버튼에 이벤트 리스너 추가
                document.querySelectorAll('.map-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        // Remove the 'selected' class from all rows
                        // document.querySelectorAll('#data-container tr').forEach(tr => tr.classList.remove('selected'));
                        // this.closest('tr').classList.add('selected');
                        //
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        openMap(window.allFetchedItems[origIndex]);
                    });
                });

                // 현재상가와 가까운 거리에 위지상가 비교
                document.querySelectorAll('.rent-distance-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        //
                        let origIndex = this.closest('tr').getAttribute('data-link');
                        if (origIndex === null) {
                            alert("선택된 행의 인덱스를 찾을 수 없습니다.");
                            return;
                        }
                        // window.allFetchedItems 배열에서 원본 인덱스(origIndex)에 해당하는 항목을 전달
                        applyPoupuRentPrice(window.allFetchedItems[origIndex]);
                    });
                });
            }

            // 상세 보기 버튼 종료 이벤트 리스너 추가
            document.querySelectorAll('.close-btn').forEach(button => {
                button.addEventListener('click', function () {
                    $('#detailPopup').hide();
                });
            });

            function openDetailPopup(item) {
                //
                const article_no = item.article_no;
                var url = "https://fin.land.naver.com/articles/" + article_no;
                var width = 900;
                var height = 1100;

                // 전체 화면 기준 중앙 좌표 계산 (iframe 내부여도 상관없음)
                const left = (screen.width - width) / 2 + 50;
                const top = (screen.height - height) / 2;

                // 새 창 열기 (팝업 창)
                var popupWindow = window.open(url, "popup", `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);

                // 포커스 이동
                if (popupWindow) {
                    popupWindow.focus();
                }
            }

            function openMap(item) {
                const article_no = item.article_no;
                var url = "https://m.land.naver.com/near/article/" + article_no + "?poi=SCHOOLPOI";
                var width = 1400;
                var height = 1200;

                // 전체 화면 기준 중앙 좌표 계산 (iframe 내부여도 상관없음)
                const left = (screen.width - width) / 2 + 50;
                const top = (screen.height - height) / 2 - 50;

                // 새 창 열기 (팝업 창)
                var popupWindow = window.open(url, "popup", `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);

                // 포커스 이동
                if (popupWindow) {
                    popupWindow.focus();
                }
            }

            //
            // function openMap(address) {
            //     const width = 1900;
            //     const height = 1280;
            //     const left = (screen.width - width) / 2;
            //     const top = (screen.height - height) / 2;
            //     // 네이버맵 URL은 "https://map.naver.com/v5/search/" 뒤에 인코딩된 주소를 붙여서 사용합니다.
            //     window.open('https://map.naver.com/v5/search/' + encodeURIComponent(address), '_blank', 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top);
            // }

            // 검색 버튼 클릭 이벤트 수정 (입력 체크 추가)
            $('#search-btn').click(function () {
                let searchTerm = $('#locatadd_nm').val().trim(); // 검색어 가져오기
                if (!searchTerm) { // 검색어가 없을 경우 경고 메시지
                    alert("법정동명을 입력하세요.");
                    $('#locatadd_nm').focus(); // 입력란에 포커스 이동
                    return;
                }
                fetchData(); // 검색어가 존재하면 데이터 검색 실행
            });
            //
            //loadYears();

            //=========================================================
            // 조건선택 목록 처리
            function applyFilters() {
              let trade_type = document.getElementById("trade_type").value;
              let category = document.getElementById("category").value;
              //let selYear = document.getElementById("sale_year").value;
              let selPyeon = document.getElementById("pyeon").value;
              let selFloor = document.getElementById("sel_floor").value;

              // 동일그룹묶음(물건구분,층,총층수,전용면적,금액)
              let groupFilteredItems = window.allFetchedItems;
              const same_price_group_checkbox = document.getElementById("same_price_group_checkbox");
              if (same_price_group_checkbox && same_price_group_checkbox.checked) {
                let seenKeys = new Set();
                groupFilteredItems = window.allFetchedItems.filter(item => {
                  // 고유 키 생성 (필요에 따라 구분자를 변경하세요)
                  let key = `${item.article_name}_${item.cfloor}_${item.tfloor}_${item.exclusive_area_pyeong}_${item.price}`;
                  if (seenKeys.has(key)) {
                    return false;
                  } else {
                    seenKeys.add(key);
                    return true;
                  }
                });
              }
              //=================================
              //
              //filteredItems = window.allFetchedItems.filter(item => {
              let filteredItems = groupFilteredItems.filter(item => {
                let ok = true;

                if(trade_type !== "all") {
                  ok = ok && item.trade_type && item.trade_type.includes(trade_type.trim());
                }
                if(category !== "all") {
                  ok = ok && item.article_name && item.article_name.includes(category.trim());
                }
                if(selPyeon !== "all") {
                  let p = Math.floor(parseFloat(item.exclusive_area_pyeong)); // 소수점 제거 (내림 처리)
                  if(isNaN(p)) return false;
                  if(selPyeon === "9") {
                    ok = ok && (p >= 1 && p < 10);
                  } else if(selPyeon === "10") {
                    ok = ok && (p >= 10 && p < 20);
                  } else if(selPyeon === "20") {
                    ok = ok && (p >= 20 && p < 30);
                  } else if(selPyeon === "30") {
                    ok = ok && (p >= 30 && p < 40);
                  } else if(selPyeon === "40") {
                    ok = ok && (p >= 40 && p < 50);
                  } else if(selPyeon === "50") {
                    ok = ok && (p >= 50 && p < 60);
                  } else if(selPyeon === "60") {
                    ok = ok && (p >= 60 && p < 70);
                  } else if(selPyeon === "70") {
                    ok = ok && (p >= 70 && p < 100);
                  } else if(selPyeon === "100") {
                    ok = ok && (p >= 100);
                  }
                }

                // 층수 필터링: 동적 옵션(기본 옵션 제외)에서 선택된 값 기준
                if (selFloor !== "all") {
                  let p = item.cfloor ? item.cfloor.toString().trim() : ""; // null 방지 + 문자열 변환
                  if (selFloor === "low") {
                      ok = ok && (p === "B1" || p === "B2" || p === "지하" || Number(p) === 1 || Number(p) === 2);
                  } else if (selFloor === "high") {
                      ok = ok && (Number(p) >= 3);
                  } else {
                      if (isNaN(Number(selFloor))) {
                        ok = ok && (p.toString().trim() === selFloor.toString().trim());
                      } else {
                        ok = ok && (Number(p) === Number(selFloor));
                      }
                  }
                }
                // 추가 조건: rent_checkbox가 체크되고, 선택된 trade_type이 "매매"인 경우,
                // item.sale_deposit_price(보증금) 0이면 해당 항목은 필터에서 제외.
                const rentCheckbox = document.getElementById("rent_checkbox");
                if (rentCheckbox && rentCheckbox.checked && trade_type === "매매" && parseInt(item.sale_deposit_price) === 0) {
                    ok = false;
                }
                //
                return ok;
              });
                //
                renderTable(filteredItems);
                window.currentFilteredItems = filteredItems;

                // 필터후 맴처음 레코드 셀렉트 월세평균금액 처리: 로우선택시 주변월세 최소/평균/최대 구하기
                let selectedItem = window.currentFilteredItems[0];
                applySelectedRentPrice(selectedItem);
            }

            // 로우선택시 주변월세 최소/평균/최대 구하기
            function applySelectedRentPrice(item) {
                // 현재 선택로우 위경도를 기준으로 근처에 주변월세목록 가져오기
                let filteredItems = getRentDistanceFilterItems(item);

                // 최소, 평균, 최대 계산
                if (filteredItems.length > 0) {
                    let prices = filteredItems.map(item => parseFloat(item.sortPyeongPrice || 0));
                    let minPrice = Math.min(...prices);
                    let maxPrice = Math.max(...prices);
                    let total = prices.reduce((acc, price) => acc + price, 0);
                    let avgPrice = total / prices.length;
                    // 결과를 "최소/평균/최대" 형식으로, 각 숫자에 색상을 지정하여 출력
                    document.getElementById("rent_pyeon_price_avg").innerHTML =
                        `<span style="color: green;">${minPrice.toFixed(1)}</span>/ ` +
                        `<span style="color: red;">${avgPrice.toFixed(1)}</span> /` +
                        `<span style="color: blue;">${maxPrice.toFixed(1)}</span>`;
                } else {
                    document.getElementById("rent_pyeon_price_avg").innerHTML = "0/ 0 /0";
                }
            }

            // 주변월세 팝업목록
            function applyPoupuRentPrice(item) {
                // 현재 선택로우 위경도를 기준으로 근처에 주변월세목록 가져오기
                let filteredItems = getRentDistanceFilterItems(item);

                // 필터링 데이타 월세조회 팝업 생성 함수
                openRentPricePopup(filteredItems, item);
            }

            // 현재 선택로우 위경도를 기준으로 근처에 주변월세목록 가져오기
            function getRentDistanceFilterItems(item) {
              // 선택된 행 찾기 (data-index가 부여되어 있음)
              let selectedItem = item;
              if (!selectedItem || !selectedItem.latitude || !selectedItem.longitude) {
                alert("선택된 항목에 위도/경도 정보가 없습니다.");
                return;
              }

              // 상단의 distance 셀렉트 박스에서 임계값(미터)을 가져옴
              let threshold = parseFloat(document.getElementById("distance").value);
              if (isNaN(threshold)) {
                alert("유효한 거리 값을 선택하세요.");
                return;
              }
              let lat1 = parseFloat(selectedItem.latitude);
              let lon1 = parseFloat(selectedItem.longitude);

              // 내 위치(예: 사용자가 선택한 위도, 경도)
              const myLatitude = lat1; // 미리 정의된 내 위도
              const myLongitude = lon1; // 미리 정의된 내 경도
              // 내 위치와 비교할 때 허용할 오차 (예: 0.001 정도)
              const epsilon = 0.001;

              // 전체 데이터에서 선택된 항목과의 거리가 임계값 이하이고, 거래유형 조건을 만족하는 항목 필터링
              let category = document.getElementById("category").value;
              let selPyeon = document.getElementById("pyeon").value;
              let selFloor = document.getElementById("sel_floor").value;
              let filteredItems = window.allFetchedItems.filter(item => {
                  //
                  if (item.trade_type !== "월세") return false;  // 월세만 처리
                  //
                  if (!item.latitude || !item.longitude) return false;
                  //
                  let lat2 = parseFloat(item.latitude);
                  let lon2 = parseFloat(item.longitude);

                  let ok = false;
                  if (Math.abs(lat2 - myLatitude) < epsilon && Math.abs(lon2 - myLongitude) < epsilon) {
                        ok = true; // 내 위치와 거의 동일하면 포함
                  } else {
                        let distance = calculateDistance(myLatitude, myLongitude, lat2, lon2);
                        ok = (distance <= threshold);
                  }
                  //
                  if(category !== "all") {
                    ok = ok && item.article_name && item.article_name.includes(category.trim());
                  }
                  //
                  if(selPyeon !== "all") {
                      let p = Math.floor(parseFloat(item.exclusive_area_pyeong)); // 소수점 제거 (내림 처리)
                      if(isNaN(p)) return false;
                      if(selPyeon === "9") {
                        ok = ok && (p >= 1 && p < 10);
                      } else if(selPyeon === "10") {
                        ok = ok && (p >= 10 && p < 20);
                      } else if(selPyeon === "20") {
                        ok = ok && (p >= 20 && p < 30);
                      } else if(selPyeon === "30") {
                        ok = ok && (p >= 30 && p < 40);
                      } else if(selPyeon === "40") {
                        ok = ok && (p >= 40 && p < 50);
                      } else if(selPyeon === "50") {
                        ok = ok && (p >= 50 && p < 60);
                      } else if(selPyeon === "60") {
                        ok = ok && (p >= 60 && p < 70);
                      } else if(selPyeon === "70") {
                        ok = ok && (p >= 70 && p < 100);
                      } else if(selPyeon === "100") {
                        ok = ok && (p >= 100);
                      }
                  }
                  // 층수 필터링: 동적 옵션(기본 옵션 제외)에서 선택된 값 기준
                  if (selFloor !== "all") {
                      let p = item.cfloor ? item.cfloor.toString().trim() : ""; // null 방지 + 문자열 변환
                      if (selFloor === "low") {
                          ok = ok && (p === "B1" || p === "B2" || p === "지하" || Number(p) === 1 || Number(p) === 2);
                      } else if (selFloor === "high") {
                          ok = ok && (Number(p) >= 3);
                      } else {
                          if (isNaN(Number(selFloor))) {
                            ok = ok && (p.toString().trim() === selFloor.toString().trim());
                          } else {
                            ok = ok && (Number(p) === Number(selFloor));
                          }
                      }
                  }
                  return ok
              });
              return filteredItems;
            }

            // function calculateDistance(lat1, lon1, lat2, lon2) {
            //   // Haversine 공식: 두 위도/경도 사이의 거리를 미터 단위로 계산
            //   const R = 6371e3; // 지구 반경 (미터)
            //   const φ1 = lat1 * Math.PI / 180;
            //   const φ2 = lat2 * Math.PI / 180;
            //   const Δφ = (lat2 - lat1) * Math.PI / 180;
            //   const Δλ = (lon2 - lon1) * Math.PI / 180;
            //   const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
            //             Math.cos(φ1) * Math.cos(φ2) *
            //             Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            //   const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            //   const distance = R * c;
            //   return distance;
            // }

            // Haversine 공식을 이용한 거리 계산 함수 (단위: 미터)
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // 지구 반지름 (미터)
                const toRad = (angle) => (angle * Math.PI) / 180;

                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);

                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            //
            function openProfitPopup() {
                let popup = window.open("/api/menu?menu=profit", "profitPopup",
                    "resizable=yes, scrollbars=yes, menubar=no, location=no, toolbar=no");

                if (popup) {
                    popup.onload = function() {
                        let width = popup.document.documentElement.scrollWidth-500;
                        let height = popup.document.documentElement.scrollHeight-370;

                        // 팝업을 현재 화면의 중앙에 배치
                        let left = window.screenX + (window.innerWidth - width) / 2;
                        let top = window.screenY + (window.innerHeight - height) / 2;

                        popup.resizeTo(width, height);
                        popup.moveTo(left, top);
                    };
                } else {
                    alert("팝업이 차단되었습니다. 팝업 차단을 해제해주세요.");
                }
            }

            document.addEventListener("DOMContentLoaded", function() {
                //document.getElementById("profit-link").addEventListener("click", openProfitPopup);

                // 수익율처리 프로세스
                const profitInput = document.getElementById("profit");
                // 포커스 시 "%" 제거
                profitInput.addEventListener("focus", function() {
                    if (this.value.endsWith('%')) {
                      this.value = this.value.slice(0, -1);
                    }
                });
                // 블러(포커스 아웃) 시 숫자 뒤에 "%" 추가 (값이 있을 경우)
                profitInput.addEventListener("blur", function() {
                    if (this.value && !this.value.endsWith('%')) {
                      this.value += '%';
                    }
                });
                // 입력 시 숫자 외의 문자 제거
                profitInput.addEventListener("input", function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            });


            function printPreview() {
                // 인쇄할 영역의 HTML 가져오기
                const searchHTML = document.querySelector(".search-container").outerHTML;
                const dataHTML = document.querySelector(".table-container").outerHTML;

                // 새 창 크기 설정
                const windowWidth = 1350;
                const windowHeight= 1100;

                // 현재 화면 크기를 기반으로 중앙 좌표 계산
                const screenWidth = window.screen.width;
                const screenHeight = window.screen.height;
                const left = Math.floor((screenWidth - windowWidth) / 2);
                const top = Math.floor((screenHeight - windowHeight) / 2);

                // 새 창 열기 (창 크기와 위치 지정)
                const printWindow = window.open("", "", `width=${windowWidth},height=${windowHeight},left=${left},top=${top}`);

                // 새 창에 HTML 작성
                printWindow.document.write(`
                <html>
                  <head>
                    <title>프린트 미리보기</title>
                    <style>
                      body { font-family: Arial, sans-serif; padding: 20px; }
                      .search-container, #header-container, #data-container { margin-bottom: 20px; }
                      table { width: 100%; border-collapse: collapse; }
                      th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
                      th { background-color: #f2f2f2; }
                    </style>
                  </head>
                  <body>
                    ${searchHTML}
                    ${dataHTML}
                  </body>
                </html>
              `);
                printWindow.document.close();

                // 새 창 로드 후 500ms 후에 인쇄 명령 실행
                setTimeout(() => {
                printWindow.focus();
                printWindow.print();
              }, 500);
            }

            // 현재 필터되어진 화면에 평수별 그룹을 보여줌..
            function pyengPopupView(filteredItems) {
                  // 현재 선택된 거래유형(매매/월세/전체) 가져오기
                  let tradeType = $("#trade_type").val() || "전체";

                  // 평단가 추출: 현재 필터된 데이터에서 getRentPyengPriceAvgMiddleValue() 함수를 사용하여 숫자로 변환
                  let fixedPrice = parseFloat(getRentPyengPriceAvgMiddleValue());
                  if (isNaN(fixedPrice)) fixedPrice = 0;

                  let category = document.getElementById("category").value;
                  let selPyeon = document.getElementById("pyeon").value;
                  let selFloor = document.getElementById("sel_floor").value;

                  // 현재 필터된 매물 데이터(window.currentFilteredItems)를 10평 단위로 그룹화
                  let rentFilteredItems = filteredItems === null || filteredItems.length <= 0  ? window.currentFilteredItems : filteredItems;
                  let groups = {};
                  rentFilteredItems.forEach(item => {
                      let areaVal = parseFloat(item.exclusive_area_pyeong);
                      let groupKey;
                      if (isNaN(areaVal)) {
                        groupKey = "미정";
                      } else if (areaVal < 10) {
                        groupKey = "9";
                      } else {
                        // areaVal가 10 이상인 경우, 10 단위로 그룹화 (10~19.9 → 10평대, 20~29.9 → 20평대 등)
                        groupKey = (Math.floor(areaVal / 10) * 10);
                      }
                      if (!groups[groupKey]) {
                        groups[groupKey] = [];
                      }
                      groups[groupKey].push(item);
                  });
                  // 각 그룹별 건수와 총금액(그룹 평수 × 건수 × 평단가) 계산
                  let groupArray = [];
                  let overallCount = 0;
                  let overallTotal = 0;
                  for (let key in groups) {
                    let bucket = (key === "미정") ? key : parseInt(key);
                    let count = groups[key].length;
                    let totalAmount = (bucket === "미정") ? 0 : bucket * count * fixedPrice;
                    overallCount += count;
                    overallTotal += totalAmount;
                    groupArray.push({ bucket, count, total: totalAmount });
                  }

                  // 숫자형 그룹은 오름차순 정렬, "미정" 그룹은 마지막에 배치
                  groupArray.sort((a, b) => {
                    if (a.bucket === "미정") return 1;
                    if (b.bucket === "미정") return -1;
                    return a.bucket - b.bucket;
                  });

                  // 팝업 내용 HTML 구성 (제목, 그룹별 데이터, 전체 요약 및 닫기 버튼)
                  let popupHtml = `
                    <div id="pyengPopup" style="
                        position: fixed;
                        top: 50%; left: 50%;
                        transform: translate(-50%, -50%);
                        background: #fff;
                        padding: 20px;
                        border: 2px solid #007bff;
                        border-radius: 8px;
                        z-index: 3000;
                        max-width: 400px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                    ">
                      <h3 style="margin-top: 0;">${tradeType} 분석( ${fixedPrice} )</h3>
                      <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                          <tr>
                            <th style="border: 1px solid #ddd; padding: 5px;">평형</th>
                            <th style="border: 1px solid #ddd; padding: 5px;">건수</th>
                            <th style="border: 1px solid #ddd; padding: 5px;">총금액</th>
                          </tr>
                        </thead>
                        <tbody>
                  `;

                  groupArray.forEach(group => {
                    let bucketLabel = (group.bucket === "미정") ? "미정" : group.bucket + "평대";
                    let formattedTotal = group.bucket === "미정" ? "-" : formatNumber(group.total.toFixed(0));
                    popupHtml += `
                      <tr>
                        <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${bucketLabel}</td>
                        <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${group.count}</td>
                        <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${formattedTotal}</td>
                      </tr>
                    `;
                  });

                  // 전체 요약 (전체 건수와 전체 총금액)
                  let overallFormattedTotal = formatNumber(overallTotal.toFixed(0));
                  popupHtml += `
                           <tr>
                                <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">총계</td>
                                <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${overallCount}</td>
                                <td style="border: 1px solid #ddd; padding: 5px; text-align: center;">${overallFormattedTotal}</td>
                          </tr>
                        </tbody>
                      </table>
                      <button id="pyengPopupClose" style="
                          display: block;
                          margin: 10px auto;
                          padding: 5px 10px;
                          cursor: pointer;
                          background: #007bff;
                          color: #fff;
                          border: none;
                          border-radius: 4px;
                      ">닫기</button>
                    </div>
                  `;

                  // 팝업을 body에 추가하고 닫기 버튼 이벤트 등록
                  $("body").append(popupHtml);
                  $("#pyengPopupClose").click(function() {
                    $("#pyengPopup").remove();
                  });
            }
            //======================================================
            // 월세조회 팝업 생성 함수
            function openRentPricePopup(filteredItems, selectedItem) {

                // 중복제거-물건구분,층,총층,전용면적,보증금/월세
                let seenKeys = new Set();
                filteredItems = filteredItems.filter(item => {
                  // 고유 키 생성 (필요에 따라 구분자를 변경하세요)
                  let key = `${item.article_name}_${item.cfloor}_${item.tfloor}_${item.exclusive_area_pyeong}_${item.price}_${item.rentPrc}`;
                  if (seenKeys.has(key)) {
                    return false;
                  } else {
                    seenKeys.add(key);
                    return true;
                  }
                });
                //===============================
                let rentFilteredItems = filteredItems;

                // 1. Extract unique floor and area groups (area: 0~9.9 becomes 9, otherwise Math.floor(area/10)*10)
                let floorSet = new Set();
                let areaSet = new Set();
                filteredItems.forEach(item => {
                    if (item.cfloor) {
                        floorSet.add(item.cfloor);
                    }
                    if (item.exclusive_area_pyeong) {
                        let area = parseFloat(item.exclusive_area_pyeong);
                        if (!isNaN(area)) {
                            let areaGroup = (area < 10) ? 9 : Math.floor(area / 10) * 10;
                            areaSet.add(areaGroup);
                        }
                    }
                });
                let floorArray = Array.from(floorSet).sort((a, b) => a - b);
                let areaArray = Array.from(areaSet).sort((a, b) => a - b);

                // 2. Build the floor and area select lists with parent's select style (padding, border, border-radius)
                let selFloor = document.getElementById("sel_floor").value;
                let selectStyle = "padding:8px; border:1px solid #ddd; border-radius:4px;";
                let floorSelectHtml = `<select id="popupFloorSelect" style="margin-right:5px; ${selectStyle}">
                    <option value="all" ${selFloor === "all" ? "selected" : ""}>전체</option>
                    <option value="low" ${selFloor === "low" ? "selected" : ""}>저층</option>
                    <option value="high" ${selFloor === "high" ? "selected" : ""}>상층</option>`;
                floorArray.forEach(floor => {
                    // selFloor는 문자열이므로, floor를 문자열로 비교합니다.
                    floorSelectHtml += `<option value="${floor}" ${selFloor === floor.toString() ? "selected" : ""}>${floor}층</option>`;
                });
                floorSelectHtml += `</select>`;

                let areaSelectHtml = `<select id="popupAreaSelect" style="${selectStyle}">
                    <option value="all">전체</option>`;
                areaArray.forEach(area => {
                    areaSelectHtml += `<option value="${area}">${area}평</option>`;
                });
                areaSelectHtml += `</select>`;

                // 3. Calculate averages (평단가 and 평균보증금) from the filteredItems
                let averages = calculateMonthlyRentAverages(filteredItems);

                // 만원 단위의 숫자를 문자열로 변환 (함수 내부에서 콤마 제거 작업을 하고 있으므로)
                let sortProfitSalePrice = convertToKoreanAmount(selectedItem.sortProfitSalePrice.toString());

                // 평균보증금의한 예상매매가(선택품목, 평균보증금/평균월세)
                let expectedValues = expectedSellingPriceByRentAvg(selectedItem, averages.avgDepositFormatted, averages.avgRentFormatted)

                // 4. Build the header area (styled similarly to the search-container header)
                let headerHtml =
                    `<div id="monthlyPopupHeader" style="
                        background-color:#fff;
                        padding:10px;
                        border-radius:8px;
                        box-shadow:0 2px 4px rgba(0,0,0,0.1);
                        width:97%;
                        margin-bottom:5px;
                        cursor: move;
                        position: relative;
                     ">
                         <h3 style="margin:0; font-size:18px;">월세조회 - ${document.getElementById("distance").value}M</h3>
                         <p style="margin:9px 0 0; font-size:16px;">
                             선택: ${selectedItem.cfloor}/${selectedItem.tfloor}층, ${selectedItem.exclusive_area_pyeong}평(전용),
                             ${selectedItem.price}, @${selectedItem.sortPyeongPrice.toFixed(0)}, 월세(${selectedItem.sale_deposit_price}/${selectedItem.sale_rent_price}),
                             기준매매가: 월세-<span style="color:blue; font-weight:bold;">${sortProfitSalePrice}</span>,추정-<span id="expectedSellingPrice" style="color:green; font-weight:bold;">${expectedValues.profitExpectedSellingAmt}</span>
                         </p>
                         <span id="dragHandleIcon" style="
                             position:absolute;
                             right:10px;
                             top:10px;
                             font-size:18px;
                             color:#999;
                         ">＋</span>
                     </div>`;

                // 5. Build the filters area – similar style to the parent's filter group.
                let filtersHtml =
                    `<div id="popupFilters" style="
                        background-color:#fff;
                        padding:10px;
                        border-radius:8px;
                        box-shadow:0 2px 4px rgba(0,0,0,0.1);
                        width:97%;
                        margin-bottom:1px;
                        display:flex;
                        align-items:center;
                        justify-content: space-between;
                     ">
                         <div>
                             ${floorSelectHtml} ${areaSelectHtml}
                             <input type="checkbox" id="rent_avg_checkbox">
                             <label for="rent_avg_checkbox">최대,최소제외</label>
                         </div>
                         <div style="display:flex; align-items:center;">
                             <div id="avgPyeongPriceSpan" style="color:red; font-weight:bold; padding:5px;">
                                 (평단가: <span style="color:green; font-weight:bold;">${averages.minPriceFormatted}</span> / <span style="color:red; font-weight:bold;">${averages.avgPriceFormatted}</span> / <span style="color:blue; font-weight:bold;">${averages.maxPriceFormatted}</span>), 평균보증금: ${averages.avgDepositFormatted}/<span style="color:green; font-weight:bold;">${averages.avgRentFormatted}</span>
                             </div>
                             <button id="pyeonPopupBtn" style="
                                    padding: 9px 9px;
                                    border: 1px solid black;
                                    cursor: pointer;
                                    margin-bottom: 0px;
                             ">평형분석</button>
                         </div>
                     </div>`;

                // Combine header and filters into one header block
                let fullHeaderHtml = headerHtml + filtersHtml;

                // 6. Build the table header with fixed widths (no borders on TR)
                let tableHeaderHtml =
                    `<thead style="position: sticky; top: 0; background-color: #f2f2f2; z-index: 10;">
                        <tr style="border:none;">
                            <th style="width:9.00%; position: static;">순번</th>
                            <th style="width:16.28%; position: static;">물건구분</th>
                            <th style="width:7.28%; position: static;">층</th>
                            <th style="width:8.28%; position: static;">총층수</th>
                            <th style="width:11.28%; position: static;">전용면적</th>
                            <th style="width:15.28%; position: static;">월세</th>
                            <th style="width:14.28%; position: static;">평단가</th>
                            <th style="width:16.28%; position: static;">위치가기</th>
                        </tr>
                    </thead>`;

                // 7. Build the table body with no border on TR
                filteredItems.sort((a, b) => b.sortPyeongPrice - a.sortPyeongPrice);
                let tableBodyHtml = "";
                filteredItems.forEach((item, index) => {
                    let priceValue = formatNumber(item.price) + '/' +
                        '<span style="color: green;">' + formatNumber(item.rentPrc) + '</span>';
                    tableBodyHtml +=
                        `<tr data-index="${item.originalIndex}" style="border:none;">
                            <td style="width:9.01%; border-left:none; border-right:none;">${index + 1}</td>
                            <td style="width:17.01%; border-left:none; border-right:none;">${item.article_name || ""}</td>
                            <td style="width:7.88%; border-left:none; border-right:none;">${item.cfloor || ""}</td>
                            <td style="width:9.00%; border-left:none; border-right:none;">${item.tfloor || ""}</td>
                            <td style="width:11.40%; border-left:none; border-right:none;">${item.exclusive_area_pyeong || ""}</td>
                            <td style="width:15.99%; border-left:none; border-right:none;">${priceValue || ""}</td>
                            <td style="width:13.35%; border-left:none; border-right:none;">@${item.sortPyeongPrice.toFixed(1) || ""}</td>
                            <td style="width:16.28%; border-left:none; border-right:none;"><button class="map-btn-popup" data-index="${item.originalIndex}">위치가기</button></td>
                        </tr>`;
                });

                // 8. Assemble the full popup HTML – using styles similar to search-container and table-container
                let popupHtml =
                    `<div id="monthlyPopup" style="
                        position: fixed;
                        top: 45%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 700px;
                        max-height: 99%;
                        background-color: #fff;
                        border: 2px solid #007bff;
                        border-radius: 8px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                        display: flex;
                        flex-direction: column;
                     ">
                        ${fullHeaderHtml}
                        <div id="popupDataContainer" style="width:100%; overflow-y:auto; max-height:400px;">
                            <table border="1" style="border-collapse: collapse; width:100%;">
                                ${tableHeaderHtml}
                                <tbody>
                                    ${tableBodyHtml}
                                </tbody>
                            </table>
                        </div>
                        <button id="monthlyPopupClose" style="
                            margin: 10px auto;
                            padding: 8px 16px;
                            background-color: #007bff;
                            color: #fff;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 16px;
                            display: block;
                        ">닫기</button>
                    </div>`;

                // 9. Append the popup to the body and enable dragging (only by the header)
                $("body").append(popupHtml);
                $("#monthlyPopup").draggable({
                    handle: "#monthlyPopupHeader",
                    distance: 100
                });

                // 10. "평형분석" button click event – call pyengPopupView() with the current filtered items
                $("#pyeonPopupBtn").on("click", function () {
                    pyengPopupView(rentFilteredItems);
                });

                // 11. When either select changes, update the popup table and averages
                $("#popupFloorSelect, #popupAreaSelect").on("change", function () {
                    updatePopupTable();
                });
                // 최대,최소제외
                $("#rent_avg_checkbox").on("click", function () {
                    updatePopupTable();
                });
                //
                function updatePopupTable() {
                    let selectedFloor = $("#popupFloorSelect").val();
                    let selectedArea = $("#popupAreaSelect").val();
                    let updatedItems = filteredItems.filter(item => {
                        let floorOk = true, areaOk = true;
                        if (selectedFloor !== "all") {
                            let p = item.cfloor ? item.cfloor.toString().trim() : "";
                            if (selectedFloor === "low") {
                                let floorNum = parseFloat(p);
                                if (!isNaN(floorNum)) {
                                    floorOk = (floorNum <= 2);
                                } else {
                                    let lower = p.toLowerCase();
                                    floorOk = (lower === "b1" || lower === "b2" || lower.includes("지하"));
                                }
                            } else if (selectedFloor === "high") {
                                let floorNum = parseFloat(p);
                                floorOk = !isNaN(floorNum) ? (floorNum >= 3) : false;
                            } else {
                                let floorNum = parseFloat(p);
                                floorOk = !isNaN(floorNum) ? (floorNum === parseFloat(selectedFloor)) : (p === selectedFloor);
                            }
                        }
                        if (selectedArea !== "all") {
                            let areaVal = parseFloat(item.exclusive_area_pyeong);
                            let groupVal = (areaVal < 10) ? 9 : Math.floor(areaVal / 10) * 10;
                            areaOk = (groupVal == selectedArea);
                        }
                        return floorOk && areaOk;
                    });
                    // Update the global filtered list for further analysis
                    rentFilteredItems = updatedItems
                    //
                    updatedItems.sort((a, b) => b.sortPyeongPrice - a.sortPyeongPrice);
                    let newBody = "";
                    updatedItems.forEach((item,index) => {
                        let priceValue = formatNumber(item.price) + '/' +
                            '<span style="color: green;">' + formatNumber(item.rentPrc) + '</span>';
                        newBody +=
                            `<tr data-index="${item.originalIndex}" style="border:none;">
                                <td style="width:9.01%; border-left:none; border-right:none;">${index + 1}</td>
                                <td style="width:17.01%; border-left:none; border-right:none;">${item.article_name || ""}</td>
                                <td style="width:7.88%; border-left:none; border-right:none;">${item.cfloor || ""}</td>
                                <td style="width:9.00%; border-left:none; border-right:none;">${item.tfloor || ""}</td>
                                <td style="width:11.40%; border-left:none; border-right:none;">${item.exclusive_area_pyeong || ""}</td>
                                <td style="width:15.99%; border-left:none; border-right:none;">${priceValue || ""}</td>
                                <td style="width:13.35%; border-left:none; border-right:none;">@${item.sortPyeongPrice.toFixed(1) || ""}</td>
                                <td style="width:16.28%; border-left:none; border-right:none;"><button class="map-btn-popup" data-index="${item.originalIndex}">위치가기</button></td>
                            </tr>`;
                    });
                    $("#popupDataContainer table tbody").html(newBody);

                    // Recalculate averages
                    let newAverages = calculateMonthlyRentAverages(updatedItems);
                    $("#avgPyeongPriceSpan").html(
                        `(평단가: <span style="color:green; font-weight:bold;">${newAverages.minPriceFormatted}</span> / <span style="color:red; font-weight:bold;">${newAverages.avgPriceFormatted}</span> / <span style="color:blue; font-weight:bold;">${newAverages.maxPriceFormatted}</span>), 평균보증금: ${newAverages.avgDepositFormatted}/<span style="color:green; font-weight:bold;">${newAverages.avgRentFormatted}</span>`
                    );

                    // 평균보증금의한 예상매매가(선택품목, 평균보증금/평균월세)
                    let expectedValues = expectedSellingPriceByRentAvg(selectedItem, newAverages.avgDepositFormatted, newAverages.avgRentFormatted)
                    document.getElementById("expectedSellingPrice").textContent = expectedValues.profitExpectedSellingAmt;
                }

                // 12. "위치가기" button click event (inside popup)
                $("#monthlyPopup").on("click", ".map-btn-popup", function () {
                    let origIndex = $(this).data("index");
                    let item = window.allFetchedItems[origIndex];
                    if (item) {
                        openMap(item);
                    } else {
                        alert("해당 항목을 찾을 수 없습니다.");
                    }
                });

                // 13. Close button event: center the button (using auto margins)
                $("#monthlyPopupClose").click(function () {
                    $("#monthlyPopup").remove();
                });
            }

            // Helper function: Calculate monthly rent average (평단가) and average deposit
            function calculateMonthlyRentAverages(filteredItems) {
                // sortPyeongPrice를 이용한 평단가 계산
                let prices = filteredItems.map(item => parseFloat(item.sortPyeongPrice || 0));
                // 보증금(가격) 계산: convertKoreanToNumber(item.price)
                let depositValues = filteredItems.map(item => parseFloat(convertKoreanToNumber(item.price) || 0));
                // rentPrc를 이용한 월세금액 계산
                let rentPrcValues = filteredItems.map(item => parseFloat(item.rentPrc || 0));

                // rent_avg_checkbox가 체크된 경우 극단값(최소, 최대)을 제거함
                const rentAvgCheckbox = document.getElementById("rent_avg_checkbox");
                if (rentAvgCheckbox && rentAvgCheckbox.checked) {
                    if (prices.length > 2) {
                        const globalMinPrice = Math.min(...prices);
                        const globalMaxPrice = Math.max(...prices);
                        prices = prices.filter(p => p !== globalMinPrice && p !== globalMaxPrice);
                    }
                    if (depositValues.length > 2) {
                        const globalMinDeposit = Math.min(...depositValues);
                        const globalMaxDeposit = Math.max(...depositValues);
                        depositValues = depositValues.filter(d => d !== globalMinDeposit && d !== globalMaxDeposit);
                    }
                    if (rentPrcValues.length > 2) {
                        const globalMinRent = Math.min(...rentPrcValues);
                        const globalMaxRent = Math.max(...rentPrcValues);
                        rentPrcValues = rentPrcValues.filter(r => r !== globalMinRent && r !== globalMaxRent);
                    }
                }

                // 평단가 통계 계산
                let minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                let maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
                let totalPrice = prices.reduce((acc, p) => acc + p, 0);
                let avgPrice = prices.length > 0 ? totalPrice / prices.length : 0;
                let minPriceFormatted = minPrice.toFixed(1);
                let avgPriceFormatted = avgPrice.toFixed(1);
                let maxPriceFormatted = maxPrice.toFixed(1);

                // 보증금 통계 계산 (만원 단위)
                let minDeposit = depositValues.length > 0 ? Math.min(...depositValues) : 0;
                let totalDeposit = depositValues.reduce((acc, d) => acc + d, 0);
                let avgDeposit = depositValues.length > 0 ? totalDeposit / depositValues.length : 0;
                let avgDepositFormatted = formatNumber((avgDeposit / 10000).toFixed(0));

                // rentPrc를 이용한 월세금액 통계 계산
                let minRent = rentPrcValues.length > 0 ? Math.min(...rentPrcValues) : 0;
                let maxRent = rentPrcValues.length > 0 ? Math.max(...rentPrcValues) : 0;
                let totalRent = rentPrcValues.reduce((acc, r) => acc + r, 0);
                let avgRent = rentPrcValues.length > 0 ? totalRent / rentPrcValues.length : 0;
                let minRentFormatted = minRent.toFixed(0);
                let avgRentFormatted = avgRent.toFixed(0);
                let maxRentFormatted = maxRent.toFixed(0);

                return {
                    minPriceFormatted,
                    avgPriceFormatted,
                    maxPriceFormatted,
                    avgDepositFormatted,
                    avgRentFormatted
                };
            }
            // 평균보증금의한 예상매매가(선택품목, 평균보증금/평균월세)
            function expectedSellingPriceByRentAvg(selectedItem, avgDepositPrice, avgRentPrice) {

                console.log(avgDepositPrice, avgRentPrice);

                // 수익율계산하기
                const profit = Number(document.getElementById('profit').value.replace(/[^0-9]/g, ''));
                let profitExpectedSellingAmt = 0;   // 월세평균적용되어진 수익율매매가.
                let profitPercent = (profit / 100);
                if (profit == 6) {
                    //profitPercent = 200;
                }
                // 평균월세
                let rent_price_avg = avgRentPrice.replace(',','');
                let rentPriceAvg = parseFloat(rent_price_avg) * 10000;
                // 평균보증금
                let deposit_price_avg = avgDepositPrice.replace(',','');
                let depositPriceAvg = parseFloat(deposit_price_avg) * 10000;

                // (평균월세 * 12) / 수일율 + 보증금
                let calcProfitRentAvgSaleAmt = (rentPriceAvg * 12) / profitPercent.toFixed(3);
                let compProfitRentAvgSaleAmt = calcProfitRentAvgSaleAmt + depositPriceAvg;

                // 단위 변환: 원 → 만원 (1만원 = 10,000원)
                calcProfitRentAvgSaleAmt = compProfitRentAvgSaleAmt / 10000;
                // 만원 단위의 숫자를 문자열로 변환 (함수 내부에서 콤마 제거 작업을 하고 있으므로)
                profitExpectedSellingAmt =  convertToKoreanAmount(calcProfitRentAvgSaleAmt.toString());
                //alert(profitExpectedSellingAmt);

                return {
                    profitExpectedSellingAmt
                }
            }
        });
    </script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    </head>
<body>
<h2>상가매물 데이터 검색(<span id="profit-link" style="color: blue; font-size: 25px; text-decoration: underline; cursor: pointer;">수익율표)</span>
    <input type="hidden" id="api-link">
    </h2>
    <div class="search-container">
        <div class="search-input-group">
            <input type="text" id="locatadd_nm" placeholder="법정동명을 입력하세요">
            <ul id="suggestions"></ul>
            <input type="text" id="aptNm" placeholder="단지명을 입력하세요">
            <!-- 체크박스 추가 -->
            <input type="checkbox" id="same_price_group_checkbox">
            <label for="same_price_group_checkbox">동일묶음,</label>
            <label for="distance">거리:</label>
            <select id="distance">
                <option value="20">20M</option>
                <option value="30">30M</option>
                <option value="50">50M</option>
                <option value="70">70M</option>
                <option value="99">100M</option>
                <option value="100">100이상</option>
            </select>
            <button class="search-btn" id="search-btn">검색</button>
            <!-- 프린트 버튼 추가 -->
            <button id="print-btn">프린트</button>
            <!-- 평형분석 추가 -->
            <button id="pyeon-btn">평형분석</button>
        </div>
        <div class="filter-group">
            <label for="trade_type">거래유형:</label>
            <select id="trade_type">
                <option value="">전체</option>
                <option value="매매">매매</option>
                <option value="월세">월세</option>
            </select>
            <label for="category">물건구분:</label>
            <select id="category">
                <option value="">전체</option>
                <option value="일반상가">일반상가</option>
                <option value="복합상가">복합상가</option>
                <option value="단지내상가">단지내상가</option>
                <option value="사무실">사무실</option>
            </select>
<!--            <label for="sale_year">년:</label>-->
<!--            <select id="sale_year">-->
<!--                <option value="">전체</option>-->
<!--            </select>-->
            <label for="pyeon">평형:</label>
            <select id="pyeon">
                <option value="all">전체</option>
                <option value="9">9평대</option>
                <option value="10">10평대</option>
                <option value="20">20평대</option>
                <option value="30">30평대</option>
                <option value="40">40평대</option>
                <option value="50">50평대</option>
                <option value="60">60평대</option>
                <option value="70">70평대</option>
                <option value="100">100평대</option>
                <option value="00">기타</option>
            </select>
            <!-- 층수 -->
            <label for="sel_floor">층:</label>
            <select id="sel_floor">
                <option value="all">전체</option>
            </select>
            <!-- 수익율 -->
            <input type="text" id="profit" value="6%" placeholder="수익율">
             <label for="rent_pyeon_price_avg">월세:</label>
<!--             <input type="text" id="rent_pyeon_price_avg" value="0" placeholder="월세평균" readonly>-->
            <!-- 기존 input 대신 span 요소로 변경 -->
            <span id="rent_pyeon_price_avg">0/ 0 /0</span>
             <!-- 체크박스 추가 -->
            <input type="checkbox" id="rent_checkbox">
            <label for="rent_checkbox">0 제외</label>
            <!-- 평규단가 표시 요소 -->
            <span id="result-amt">평균단가/금액: 0/0</span>
            <span id="result-count" style="margin-left: auto;">건수: 0</span>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th id="sortConfirmDate" style="flex:1;">매물일자 ▼</th>
<!--                    <th>기사번호</th>-->
                    <th id="sortTrade" style="flex:1.5;">거래유형 ▼</th>
                    <th id="sortCategory" style="flex:1;">물건구분 ▼</th>
                    <th id="sortFloor" style="flex:0.5;">층수 ▼</th>
                    <th style="flex:0.5;">총층수</th>
                    <th style="flex:1;">방향</th>
                    <th id="sortBuildingArea" style="flex:1;">전용면적(평) ▼</th>
                    <th id="sortPrice" style="flex:1;">가격 ▼</th>
                    <th id="sortPyeongPrice" style="flex:1;">평단가 ▼</th>
                    <th id="sortRentPyeongPrice" style="flex:1;">매매월세 ▼</th>
                    <th id="sortProfitPrice" style="flex:1;">월세매매가 ▼</th>
<!--                    <th>중개사명</th>-->
                    <th style="flex:0.5;">지도</th>
                    <th style="flex:1;">상세</th>
                    <th style="flex:1;">분석</th>
                </tr>
            </thead>
            <tbody id="data-container"></tbody>
        </table>
        <div id="loading" class="loading-message" style="display: none;">데이터 검색 중입니다...</div>
        <div id="noData" class="no-data-message">데이터를 검색해 주세요.</div>
        <div id="errorMessage" class="error-message" style="display: none; color: red; margin-top: 10px; text-align: center"></div>
    </div>

    <!-- 상세 정보 팝업 -->
    <div id="detailPopup">
        <button class="close-btn">×</button>
        <h2>상세 정보</h2>
        <div id="detailContent"></div>
    </div>
</body>
</html>
