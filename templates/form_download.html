<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>양식다운로드</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
      margin: 20px;
      color: #333;
      text-align: center;
    }
    h1 {
      color: #007bff;
      margin-bottom: 10px;
    }

    /* 검색 영역 */
    .search-bar {
      width: 80%;
      margin: 0 auto 10px auto;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      font-size: 0.9rem;
    }
    .search-bar label {
      margin-right: 5px;
      font-weight: bold;
    }
    .search-bar input {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    /* 테이블을 감싸는 컨테이너 */
    .table-container {
      width: 95%;
      margin: 0 auto;
      max-height: 550px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #dee2e6;
      padding: 4px;
      text-align: center;
      font-size: 0.85rem;
    }
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .download-btn {
      padding: 4px 10px;
      font-size: 0.8rem;
      background-color: #007bff;
      color: #fff;
      text-decoration: none;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .download-btn:hover {
      background-color: #0056b3;
    }
  </style>
<script>
  let allFiles = []; // 전체 목록 저장용

  // 파일 다운로드 처리
  function downloadFile(fileName) {
    const url = '/api/form_down?fileName=' + encodeURIComponent(fileName);
    const a = document.createElement('a');
    a.href = url;
    a.download = '';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // 테이블 행 렌더링
  function renderTable(files) {
    const tbody = document.getElementById('forms-table-body');
    let rows = "";
    files.forEach((fileName, index) => {
      rows += `<tr>
                 <td>${index + 1}</td>
                 <td>${fileName}</td>
                 <td><button class="download-btn" onclick="downloadFile('${fileName}')">다운로드</button></td>
               </tr>`;
    });
    tbody.innerHTML = rows;
  }

  // 유니코드 정규화 + 소문자 변환
  function normalizeText(text) {
    return text.normalize("NFC").toLowerCase();
  }

  // 검색 기능 (대소문자/유니코드 차이 무시)
  function filterTable() {
    const keyword = normalizeText(document.getElementById('search-input').value.trim());
    if (keyword === "") {
      renderTable(allFiles); // 공백이면 전체목록
    } else {
      const filtered = allFiles.filter(f => normalizeText(f).includes(keyword));
      renderTable(filtered);
    }
  }

  // 서버에서 목록 불러오기
  async function loadForms() {
    try {
      const res = await fetch('/api/form_list');
      if (!res.ok) throw new Error("파일 목록을 불러오지 못했습니다.");
      const data = await res.json();
      allFiles = data.files;
      renderTable(allFiles);
    } catch (e) {
      alert("❌ 오류: " + e.message);
    }
  }

  window.onload = loadForms;
</script>
</head>
<body>
  <h1>양식다운로드</h1>

  <!-- 검색창 -->
  <div class="search-bar">
    <label for="search-input">제목:</label>
    <input type="text" id="search-input" onkeyup="filterTable()" placeholder="파일명 입력">
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>순번</th>
          <th>파일명</th>
          <th>다운로드</th>
        </tr>
      </thead>
      <tbody id="forms-table-body">
        <!-- JS로 채워짐 -->
      </tbody>
    </table>
  </div>
</body>
</html>
