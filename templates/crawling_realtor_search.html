<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>국토부 실거래 데이터</title>
  <style>
    /* 전체 페이지 중앙 정렬 */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background-color: #f9f9f9;
    }
    h2 {
      font-size: 28px;
      color: #333;
      margin-bottom: 15px;
    }
    /* 검색 컨테이너 스타일 */
    .search-container {
      margin-bottom: 5px;
      background-color: #fff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }
    .search-input-group {
      display: flex;
      gap: 10px;
      width: 100%;
      position: relative;
    }
    .search-input-group label {
      font-weight: bold;
      display: flex;
      align-items: center;
      text-align: left;
    }
    .search-input-group input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #locatadd_nm { flex: 7; }
    .search-btn, .message-btn, .excel-btn {
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }
    .search-btn:hover, .message-btn:hover, .excel-btn:hover {
      background-color: #0056b3;
    }
    #result-count {
      width: 40px;
      font-weight: bold;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
      margin-left: auto;
      margin-right: auto;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 30px;
    }
    #header-container {
      width: 95%;
      max-width: 940px;
      display: flex;
      background-color: #f2f2f2;
      font-weight: bold;
      padding: 12px 0;
      border: 1px solid #ddd;
      box-sizing: border-box;
      margin-bottom: 1px;
    }
    #header-container span {
      text-align: center;
      padding: 0 5px;
      flex: 1;
      border-right: 1px solid #ddd;
    }
    #header-container span:last-child { border-right: none; }
    .table-container {
      width: 95%;
      max-width: 940px;
      max-height: 980px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 0;
      margin-top: 1px;
      overflow: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 14px;
    }
    th { background-color: #f2f2f2; font-weight: bold; }
    .highlight { color: red; font-weight: bold; }
    .right-align { text-align: right; }
    .left-align { text-align: left; }
    .center-align { text-align: center; }
    .no-data-message, .loading-message {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #007bff;
      margin: 50px auto;
    }
    .error-message {
      color: red;
      margin-top: 10px;
      text-align: center;
    }
    #message-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      border: 2px solid #007bff;
      border-radius: 8px;
      z-index: 2000;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .popup-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px 0;
      position: relative;
      text-align: center;
    }
    .popup-header h3 {
      margin: 0;
      flex: 1;
    }
    .popup-count {
      position: absolute;
      right: 0;
      font-size: 14px;
      color: #555;
    }
    #message-popup .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    #selected-list-container {
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    .selected-list-header, .selected-list-item {
      display: flex;
      align-items: center;
      padding: 8px;
    }
    .selected-list-header span,
    .selected-list-item span {
      text-align: center;
      border-right: 1px solid #ddd;
    }
    .selected-list-header span:nth-child(1),
    .selected-list-item span:nth-child(1) { width: 30px; }
    .selected-list-header span:nth-child(2),
    .selected-list-item span:nth-child(2) { flex: 2; }
    .selected-list-header span:nth-child(3),
    .selected-list-item span:nth-child(3) { flex: 2; }
    .selected-list-item .delete-btn {
      margin-left: auto;
      cursor: pointer;
      color: red;
      font-weight: bold;
      padding: 0 8px;
    }
    #message-popup textarea {
      width: 100%;
      height: 200px;
      margin-top: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
    /* 첨부파일 썸네일 슬라이더 */
    .attachment-container {
      margin-top: 10px;
    }
    .attachment-container input[type="file"] {
      display: block;
      margin-bottom: 10px;
    }
    .thumbnail-slider {
      width: 100%;
      overflow: hidden;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .thumbnail-list {
      display: flex;
      transition: transform 0.3s ease;
    }
    .thumbnail-item {
      width: calc((100% - 15px) / 4);
      height: 80px;
      margin-right: 5px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .thumbnail-item:last-child { margin-right: 0; }
    .thumbnail-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }
    /* 삭제 버튼 오버레이 */
    .thumbnail-item .thumb-delete { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: white; width: 20px; height: 20px; text-align: center; line-height: 20px; border-radius: 50%; font-weight: bold; cursor: pointer; }
    .thumb-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 25px;
      height: 25px;
      background-color: rgba(0,0,0,0.5);
      color: #fff;
      text-align: center;
      line-height: 25px;
      cursor: pointer;
      border-radius: 50%;
      user-select: none;
      z-index: 1;
    }
    .thumb-nav.left { left: 5px; }
    .thumb-nav.right { right: 5px; }
    #image-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    #image-popup img {
      max-width: 90%;
      max-height: 90%;
      border: 5px solid #fff;
      border-radius: 8px;
    }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:nth-child(even) { background-color: azure; }
    tbody tr:hover { background-color: #d9d9d9; }
    /* 메시지 팝업 추가 입력 영역 */
    .add-entry {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .add-entry label {
      font-weight: bold;
    }
    .add-entry input {
      padding: 4px 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    #add-entry-btn {
      padding: 6px 12px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #add-entry-btn:hover { background-color: #218838; }

    /* 확인 모달 스타일 */
    #confirm-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      border: 2px solid #007bff;
      border-radius: 8px;
      z-index: 3000;
      width: 90%;
      max-width: 500px;
      padding: 20px;
      display: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .confirm-modal-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      position: relative;
      text-align: center;
    }

    .confirm-modal-header h3 {
      margin: 0;
      color: #007bff;
      font-size: 20px;
    }

    .confirm-modal-content {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .confirm-info-row {
      margin-bottom: 10px;
    }

    .confirm-info-row label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 5px;
    }

    .confirm-info-row textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      resize: none;
      min-height: 100px;
    }

    .confirm-thumbnail-slider {
      width: 100%;
      overflow: hidden;
      position: relative;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 15px;
    }

    .confirm-thumbnail-list {
      display: flex;
      transition: transform 0.3s ease;
      padding: 5px;
    }

    .confirm-thumbnail-item {
      width: calc((100% - 15px) / 4);
      height: 80px;
      margin-right: 5px;
      flex-shrink: 0;
    }

    .confirm-thumbnail-item:last-child { margin-right: 0; }

    .confirm-thumbnail-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
    }

    .confirm-modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .confirm-send-btn {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
    }

    .confirm-send-btn:hover {
      background-color: #218838;
    }

    .confirm-close-btn {
      padding: 10px 20px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      margin-right: 10px;
    }

    .confirm-close-btn:hover {
      background-color: #c82333;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="/static/js/address_autocomplete.js"></script>
  <script src="/static/js/common.js"></script>
  <script>

    // DOM이 준비되면 window의 load 이벤트로 모든 폼 및 리소스가 완전히 로드될 때 실행합니다.
    window.onload = function() {
        var lawName = "{{ lawName }}";
        var umdNm = "{{ umdNm }}";
        var lawCd = "{{ law_cd }}";
        //alert(lawName + ',' + umdNm + ',' + lawCd);
        // 확장툴실행여부
        if (lawCd && lawCd.trim() !== '') {
            // selectedLawdCd = '4157010900';
            // selectedUmdNm = '구래동';
            selectedLawdCd = lawCd;
            selectedUmdNm = umdNm;
            document.getElementById("dangiName").value = umdNm;

            // 0.5초 후 버튼 클릭 이벤트 강제 실행
            setTimeout(() => {
                document.getElementById("search-btn").click();
                //document.getElementById("search-btn").dispatchEvent(new Event('click'));
            }, 500);
        }
    };

    // 슬라이더 관련 변수
    let currentSlide = 0;
    let totalThumbnails = 0;
    const visibleCount = 4; // 기본 4개 보임
    //
    function fetchData() {
      const selType = $('#sel_type').val();
      let searchTitle = $('#locatadd_nm').val();
      let dangiName = $('#dangiName').val();
      $('#loading').show();
      $('#noData').hide();
      $('table').hide();
      $.ajax({
        url:  BASE_URL + '/api/realtor',
        //url: 'https://erp-dev.bacchuserp.com/api'
        method: 'GET',
        data: { lawdCd: selectedLawdCd, selType:selType, searchTitle: searchTitle, dangiName: dangiName },
        dataType: 'json',
        timeout: 5000,
        beforeSend: function () {
          $('#loading').show();
          $('#noData').hide();
          $('#errorMessage').hide();
          $('table').hide();
        },
        success: function (data) {
          $('#loading').hide();
          if (data.length === 0) {
            $('#noData').show();
            $('#errorMessage').hide();
          } else {
            $('#noData').hide();
            $('#errorMessage').hide();
            $('table').show();
            window.allFetchedItems = data;
            renderTable(window.allFetchedItems);
          }
          // 업데이트: 검색 결과 건수를 #search-count에 출력
          $("#result-count").text(data.length);
        },
        error: function (xhr, status, error) {
          $('#loading').hide();
          if (status === "timeout") {
            $('#errorMessage').text("서버 응답이 없습니다. 서버가 실행 중인지 확인하세요.").show();
          } else {
            $('#errorMessage').text("데이터를 가져오는 중 오류가 발생했습니다: " + error).show();
          }
        }
      });
    }

    function renderTable(data) {
      let sel_type = document.getElementById("sel_type").value; // .value로 값 가져오기
      let tableBody = $('#dataBody');
      tableBody.empty();
      data.forEach((item, index) => {
        const address2 = item.address2?.trim();
        const address = sel_type === 'realtor' ? item.address1 : item.address1 + (address2 ? '-' + address2 : '');
        // 차후검색시 적용할 데이타
        item.address = address;
        tableBody.append(`
          <tr>
            <td class="center-align"><input type="checkbox" class="row-checkbox"></td>
            <td class="center-align">${index}</td>
            <td class="center-align">${item.title.length > 10 ? item.title.substring(0, 10) + '...' : item.title}</td>
            <td class="center-align">${item.representative.replace(/\s/g, "")}</td>
            <td class="left-align">${address.length > 25 ? address.substring(0, 25) + '...' : address}</td>
            <td class="center-align">${item.landline_phone}</td>
            <td class="center-align">${item.mobile_phone}</td>
            <td><button class="map-btn" data-map="${item.address1}">위치</button></td>
          </tr>
        `);
      });
      document.querySelectorAll('.map-btn').forEach(button => {
        button.addEventListener('click', function () {
          let address = this.getAttribute('data-map');
          openMap(address);
        });
      });
    }

    function updateThumbnailSlider() {
      const slider = document.querySelector('.thumbnail-list');
      if(slider) {
        slider.style.transform = `translateX(-${currentSlide * 85}px)`;
      }
    }

   document.addEventListener("DOMContentLoaded", function() {
      // #search-btn 클릭 이벤트
      document.getElementById('search-btn').addEventListener('click', function() {
        // let searchTerm = document.getElementById('locatadd_nm').value.trim();
        // if (!searchTerm) {
        //   alert("법정동명을 입력하세요.");
        //   document.getElementById('locatadd_nm').focus();
        //   return;
        // }
        // 상담사(loaner)와 중개사(realtor) 구분
        let selType = document.getElementById("sel_type").value;
        if (selType === "realtor") {
          let searchTerm = document.getElementById('dangiName').value.trim();
          if (!searchTerm) {
            alert("읍면동을 입력하세요.");
            document.getElementById('dangiName').focus();
            return;
          }
        }
        fetchData();
      });
      // 중개사 검색
      // document.getElementById('dangiName').addEventListener('keyup', function(event) {
      //     applyFilters();
      // });

      document.getElementById('locatadd_nm').addEventListener('keyup', function(event) {
          applyFilters();
      });

     // #sel_type변경 이벤트
      document.getElementById('sel_type').addEventListener('change', function() {
          $('#dataBody').empty();
          $('#result-count').text("0");
          document.getElementById('dangiName').value = "";
          //
          if(this.value === "loaner") {
              $('#dangiName').attr('placeholder', '지역을 입력하세요(서울등)');
              $('#locatadd_nm').attr('placeholder', '이름을 입력하세요');
          } else {
              // 상담사가 아닐 경우 기본값 또는 다른 값으로 설정할 수 있습니다.
              $('#dangiName').attr('placeholder', '읍면동을 입력하세요');
              $('#locatadd_nm').attr('placeholder', '중개소를 입력하세요');
          }
      });


      // 조건선택 목록 처리
      function applyFilters() {
        // 중개사/상담사 일때 읍면동은 주소와 비교
        let dangiName = document.getElementById("dangiName").value;
        // 중개사일때 중개소명은 제목과 비교,  상담사일때 이름은 대표자(이름)과 비교
        let locataddNm = document.getElementById("locatadd_nm").value.trim();

        // 상담사(loaner)와 중개사(realtor) 구분
        let selType = document.getElementById("sel_type").value;
        console.log(dangiName, locataddNm, selType);
        //
        let filteredItems = window.allFetchedItems.filter(item => {
          let ok = true;
          // 주소에 읍면동이 포함되어 있는지 확인
          if (dangiName !== "") {
            ok = ok && item.address && item.address.includes(dangiName.trim());
          }
          //
          if (locataddNm !== "") {
            if (selType === "loaner") {
              // 상담사일때 이름은 대표자(이름)과 비교
              ok = ok && item.representative && item.representative.includes(locataddNm.trim());
            } else {
              // 중개사일때 중개소명은 제목과 비교
              ok = ok && item.title && item.title.includes(locataddNm.trim());
            }
          }
          //
          return ok;
        });
        // 필터링된 결과의 개수를 #result-count에 표시
        document.getElementById('result-count').textContent = filteredItems.length;
        // 필터링된 결과를 테이블에 렌더링
        renderTable(filteredItems);
      }

     // #select-all 변경 이벤트
     document.getElementById('select-all').addEventListener('change', function () {
       let checked = this.checked;
       document.querySelectorAll('input.row-checkbox').forEach(function (checkbox) {
         checkbox.checked = checked;
       });
     });

     // #sms_type변경 이벤트
      document.getElementById('sms_type').addEventListener('change', function () {
         //
         document.getElementById('message-content').value = "";
         //
         let send_message = "";
         if (this.value === "sms") {
           send_message += "일반문자를 전송합니다.\n"
           document.getElementById('message-title').value = "";
           document.getElementById('message-content').value = send_message;
         } else if (this.value === "house") {
           send_message += "1.주소: 강북구 수유동 100-1번지\n";
           send_message += "2.년식: 2018\n";
           send_message += "3.평수: 20평(전용)\n";
           send_message += "4.방수: 방3-욕실2\n";
           send_message += "5.층향: 4층,남향\n";
           send_message += "6.엘베: 있슴\n";
           send_message += "7.주차: 1대무료\n";
           send_message += "8.관리비: 5만원\n";
           send_message += "9.금액: 2.5억\n";
           send_message += "10.번호: 010-2270-9085\n";
           send_message += "11.비고: 지하철5분거리, 초.중.고 2개존재함.";
           document.getElementById('message-title').value = "주택매매 의뢰";
           document.getElementById('message-content').value = send_message;
         } else {
           send_message += "1.주소: 강북구 수유동 100-1번지\n";
           send_message += "2.년식: 2018\n";
           send_message += "3.평수: 50평(전용)\n";
           send_message += "4.층향: 4층,남향\n";
           send_message += "5.엘베: 있슴\n";
           send_message += "6.주차: 1대무료(총50대),고객 2시간무료\n";
           send_message += "6.관리비: 전용 1만원\n";
           send_message += "7.금액: 3.5억\n";
           send_message += "8.번호: 010-2270-9085\n";
           send_message += "9.비고: 에어컨및 데코타일";
           document.getElementById('message-title').value = "상가임대(매매)의뢰";
           document.getElementById('message-content').value = send_message;
         }
      });

      // 알림톡,문자 선택처리
      // document.getElementById('send_tool_type').addEventListener('change', function () {
      //    const loginInfoDiv = document.getElementById("login-info");
      //    alert(this.value);
      //    if (this.value === "kakao") {
      //       loginInfoDiv.style.display = "none";
      //    } else {
      //       loginInfoDiv.style.display = "flex";
      //    }
      // });
      const sendTypeRadios = document.getElementsByName("send-type");
      const loginInfoDiv = document.getElementById("login-info");
      sendTypeRadios.forEach(radio => {
        radio.addEventListener("change", () => {
          if (document.querySelector('input[name="send-type"]:checked').value === "sms") {
            loginInfoDiv.style.display = "flex";
          } else {
            loginInfoDiv.style.display = "none";
          }
        });
      });

      // #message-btn 클릭 이벤트
      // 두가지방식: 1. 윈도우오픈방식처리, 2.DIV모달팝업방식처리
      document.getElementById('message-btn').addEventListener('click', function() {
             // --- 초기화 시작 ---
            // 1) 파일 인풋 초기화
            const fileInput = document.getElementById('file-input');
            if (fileInput) fileInput.value = '';

            // // 2) 썸네일 리스트 초기화
            // const thumbnailList = document.querySelector('.thumbnail-list');
            // if (thumbnailList) thumbnailList.innerHTML = '';

            // 4) 라디오 버튼을 알림톡(카카오)으로 초기화
            const kakaoRadio = document.querySelector('input[name="send-type"][value="kakao"]');
            if (kakaoRadio) kakaoRadio.checked = true;

            // 5) SMS 템플릿(select)을 “일반”으로 초기화
            const smsTypeSelect = document.getElementById('sms_type');
            if (smsTypeSelect) smsTypeSelect.value = 'sms';
            // --- 초기화 끝 --
            //
            let selectedItems = [];
            document.querySelectorAll('input.row-checkbox:checked').forEach(function(checkbox) {
              let row = checkbox.closest('tr');
              let tds = row.querySelectorAll('td');
              let seq = tds[1].textContent;
              let name = tds[3].textContent;
              let phone = tds[6].textContent.trim();
              if (phone.startsWith("010")) {
                selectedItems.push({ seq: seq, name: name, phone: phone });
              }
            });
            if (selectedItems.length === 0) {
              alert("선택된 항목 중 휴대전화가 '010'인 목록이 없습니다.");
              return;
            }
            //
            // 1.윈도우 오픈방식
            // window.selectedItems = selectedItems;
            // var width = 700;
            // var height = 990;
            // var left = (window.screen.width - width) / 2;
            // var top = (window.screen.height - height) / 2;
            // window.open('/api/menu?menu=realtor_pop', 'msgPopup', 'width=' + width + ',height=' + height + ',resizable=yes,scrollbars=yes,left=' + left + ',top=' + top);

            // 팝업 헤더에 건수 표시
            let popupCountElem = document.querySelector('.popup-count');
            if (popupCountElem) {
              popupCountElem.textContent = `(${selectedItems.length}건)`;
            }
            // 선택 목록 구성: 순번, 대표자, 휴대전화
            let listHtml = `
              <div id="selected-list-container">
                <div class="selected-list-header">
                  <span>순번</span>
                  <span>대표자</span>
                  <span>휴대전화</span>
                  <span>삭제</span>
                </div>
                <div id="selected-list">
            `;
            selectedItems.forEach(function(item, index) {
              listHtml += `<div class="selected-list-item">
                             <span>${index + 1}</span>
                             <span>${item.name}</span>
                             <span>${item.phone}</span>
                             <span class="delete-btn">×</span>
                           </div>`;
            });
            listHtml += `</div></div>`;
            document.getElementById('selected-list-container').innerHTML = listHtml;

            // 첨부파일 영역 초기화
            let thumbnailList = document.querySelector('.thumbnail-list');
            if (thumbnailList) {
              thumbnailList.innerHTML = '';
            }
            currentSlide = 0;
            updateThumbnailSlider();
            document.getElementById('message-title').value = "";
            document.getElementById('message-content').value = "";
            document.getElementById('message-popup').style.display = 'block';
          });

          // #send-message-btn 클릭 이벤트
          document.getElementById('send-message-btn').addEventListener('click', function() {

            // kakao, sms, naver_mms
            const selectedSendType = document.querySelector('input[name="send-type"]:checked').value;

            // 로그인 아이디와 패스워드 입력값 체크
            let loginId = document.getElementById('login-id').value.trim();
            let loginPassword = document.getElementById('login-password').value.trim();
            if (loginId === '' || loginPassword === '') {
              alert("로그인 아이디와 패스워드를 입력하세요.");
              return;
            }
            // 전송할메시지선택
            let messageTitle = document.getElementById('message-title').value.trim();
            if (messageTitle === '') {
              alert("제목을 작성해주세요..");
              return;
            }

            // 전송할메시지선택
            let messageContent = document.getElementById('message-content').value.trim();
            if (messageContent === '') {
              alert("메시지를 작성해주세요.");
              return;
            }

            // 선택된 항목들의 이름:휴대번호 쌍을 전역변수에 저장
            const pairs = Array.from(
              document.querySelectorAll('.selected-list-item')
            ).map(div => {
              const name   = div.querySelectorAll('span')[1].textContent.trim(); // 두 번째 span: 이름
              const mobile = div.querySelectorAll('span')[2].textContent.trim(); // 세 번째 span: 휴대번호
              return `${name}:${mobile}`;
            });
            window.selectedPhoneNumbers = pairs.join(',');
            console.log('현재 선택된 이름:전화번호 목록:', window.selectedPhoneNumbers);

            // 선택된 휴대전화 목록 (메시지 버튼 클릭 이벤트에서 전역변수로 저장)
            if (!window.selectedPhoneNumbers || window.selectedPhoneNumbers.length === 0) {
              alert("전송할 휴대전화 목록이 없습니다.");
              return;
            }
            //
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            if (files.length === 0) {
                  alert("첨부할 파일을 선택하세요.");
                  return;
            }

            // 유효한 파일만 담을 배열
            const validFiles = [];

            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              const ext = file.name.split('.').pop().toLowerCase();

              // 확장자 체크
              if (ext !== 'jpg') {
                alert(`"${file.name}"은(는) jpg 파일만 업로드 가능합니다.`);
                return;
              }

              // 사이즈 체크 (1MB = 1024*1024 바이트)
              if (file.size > 1 * 1024 * 1024) {
                alert(`"${file.name}"의 크기가 1MB를 초과합니다.`);
                return;
              }

              validFiles.push(file);
            }

            // 전송 타입별 레이블 맵
            const typeLabels = {
              kakao:     '알림톡',
              naver_mms: '네이버문자',
              sms:       '일반문자'
            };

            // 전송 대상 건수
            const count = window.selectedPhoneNumbers.split(',').length;
            // 레이블 결정 (기본 '메시지')
            const label = typeLabels[selectedSendType] || '메시지';

            // 사용자 확인
            if (!confirm(`${label} ${count}건을 전송하시겠습니까?`)) {
              return;
            }

            // 1차로 먼저 파일을 먼저 업로드 처리하고 처리한 업로드파일 목록을 넙겨준다.
            // FormData 객체 생성
            const formData = new FormData();
            // 선택된 파일들을 FormData에 추가
            validFiles.forEach(f => formData.append('files', f));

            // 추가 데이터 (선택적)
            formData.append('sender', 'web_client');
            formData.append('upload_time', new Date().toISOString());

            // 로딩 표시
            $("#sending-message").text("파일 전송 중...").show();

            let image_files = [];
            // AJAX로 파일 전송
            $.ajax({
              url: BASE_URL + '/api/upload_files',
              method: 'POST',
              data: formData,
              processData: false,
              contentType: false,
              timeout: 60000,
              success: function(response) {
                $("#sending-message").hide();

                if (!response.success) {
                  return alert("파일 전송 실패: " + response.message);
                }

                // 업로드된 파일명만 추출
                const image_files = response.files.map(f => f.saved_name);
                console.log('image_files:', image_files);

                // 2) 이제 SMS/MMS 전송
                $("#sending-message").text("메시지 전송 중...").show();
                $.ajax({
                  url: BASE_URL + '/api/sms_send',
                  method: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({
                    userid: loginId,
                    userpswd: loginPassword,
                    sendType: selectedSendType,
                    phoneNumbers: window.selectedPhoneNumbers,
                    title: messageTitle,
                    message: messageContent,
                    imageFiles: image_files
                  }),
                  timeout: 60000,
                  complete: function() {
                    $("#sending-message").hide();
                  },
                  success: function(resp) {
                    if (resp.result === 'Success') {
                      alert("메시지 전송 성공");
                      document.getElementById('message-popup').style.display = 'none';
                    }
                    else if (resp.result === 'PartialSuccess') {
                      alert("메시지 부분전송 성공\n" + resp.errmsg);
                      document.getElementById('message-popup').style.display = 'none';
                    }
                    else {
                      alert("메시지 전송 실패: " + resp.errmsg);
                    }
                  },
                  error: function(xhr, status, error) {
                    alert("전송 중 오류가 발생했습니다: " + error);
                  }
                });
              },
              error: function(xhr, status, error) {
                $("#sending-message").hide();
                alert("파일 전송 중 오류 발생: " + error);
              }
            }); // end of AJAX for file upload
          }); //

          // 팝업 닫기 (메시지 팝업 내 .close-btn 클릭)
          document.querySelectorAll('#message-popup .close-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                  document.getElementById('message-popup').style.display = 'none';
                });
          });

          // default 라디오 설정
          $('input[name="send-type"][value="kakao"]').prop('checked', true);

          // 삭제(X) 버튼 처리 (이벤트 위임)
          $('#selected-list-container').on('click', '.delete-btn', function() {
            $(this).closest('.selected-list-item').remove();
            updatePopupCount();
          });

          // 추가 입력 area: 이름/전화번호 포맷팅
          $('#new-phone').on('input', function() {
            let num = $(this).val().replace(/\D/g, '');
            if (num.startsWith('010')) {
              if (num.length > 3 && num.length <= 7)
                num = num.replace(/(\d{3})(\d+)/, '$1-$2');
              else if (num.length > 7)
                num = num.replace(/(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
            }
            $(this).val(num);
          });

          // 추가 버튼 클릭
          $('#add-entry-btn').on('click', function() {
            const name = $('#new-name').val().trim();
            const phone = $('#new-phone').val().trim();
            if (!name) { alert('이름을 입력하세요.'); return; }
            const phonePattern = /^010-\d{4}-\d{4}$/;
            if (!phonePattern.test(phone)) { alert('전화번호를 형식에 맞게 입력하세요 (010-xxxx-xxxx).'); return; }
            // 리스트에 추가
            const itemCount = $('#selected-list-container .selected-list-item').length + 1;
            const $item = $(`
              <div class="selected-list-item">
                <span>${itemCount}</span>
                <span>${name}</span>
                <span>${phone}</span>
                <span class="delete-btn">×</span>
              </div>
            `);
            $('#selected-list-container').append($item);
            updatePopupCount();
            // 초기화
            $('#new-name, #new-phone').val('');
          });

          function updatePopupCount() {
            const cnt = $('#selected-list-container .selected-list-item').length;
            $('.popup-count').text(`(${cnt}건)`);
            // update global phone list if needed...
          }

          // 파일 첨부 (이미지 썸네일 미리보기) - 최대 7개 첨부
          document.getElementById('file-input').addEventListener('change', function(event) {
              const files = event.target.files;
              if (files.length > 5) {
                alert("파일첨부는 최대 5개까지 가능합니다.");
                event.target.value = "";
                let thumbnailList = document.querySelector('.thumbnail-list');
                if (thumbnailList) {
                  thumbnailList.innerHTML = '';
                }
                totalThumbnails = 0;
                return;
              }
              let thumbnailList = document.querySelector('.thumbnail-list');
              if (thumbnailList) {
                thumbnailList.innerHTML = '';
              }
              totalThumbnails = files.length;
              for (let i = 0; i < totalThumbnails; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                  const div = document.createElement('div');
                  div.className = 'thumbnail-item';
                  div.innerHTML = `
                    <img src="${e.target.result}" alt="첨부이미지">
                    <span class="thumb-delete">&times;</span>
                  `;
                  // 삭제 버튼
                  div.querySelector('.thumb-delete').addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    div.remove();
                    totalThumbnails--;
                    updateThumbnailSlider();
                  });
                  thumbnailList.appendChild(div);
                };
                reader.readAsDataURL(file);
              }
          });

          // 썸네일 슬라이더 좌측 네비 버튼 클릭
          let thumbNavLeft = document.querySelector('.thumb-nav.left');
          if (thumbNavLeft) {
            thumbNavLeft.addEventListener('click', function() {
              if (currentSlide > 0) {
                currentSlide--;
                updateThumbnailSlider();
              }
            });
          }

          // 썸네일 슬라이더 우측 네비 버튼 클릭
          let thumbNavRight = document.querySelector('.thumb-nav.right');
          if (thumbNavRight) {
            thumbNavRight.addEventListener('click', function() {
              if (currentSlide < totalThumbnails - visibleCount) {
                currentSlide++;
                updateThumbnailSlider();
              }
            });
          }

          // 썸네일 클릭 시 해당 이미지를 팝업으로 표시 (이벤트 위임)
          let thumbnailList = document.querySelector('.thumbnail-list');
          if (thumbnailList) {
            thumbnailList.addEventListener('click', function(e) {
              if (e.target && e.target.matches('.thumbnail-item img')) {
                const src = e.target.getAttribute('src');
                let imagePopup = document.getElementById('image-popup');
                if (imagePopup) {
                  imagePopup.querySelector('img').setAttribute('src', src);
                  imagePopup.style.display = 'block';
                }
              }
            });
          }

          // 이미지 팝업 클릭 시 닫기
          let imagePopup = document.getElementById('image-popup');
          if (imagePopup) {
            imagePopup.addEventListener('click', function() {
              this.style.display = 'none';
            });
          }

          // #excel-btn 클릭 시 CSV 생성 및 다운로드
          $('#download-btn').click(function(){
              // 선택된 행이 없으면 알림 후 종료
              if ($('input.row-checkbox:checked').length === 0) {
                  alert("체크된 데이터가 없습니다.");
                  return;
              }

              // 헤더 행 생성
              var tableHTML = "<table>";
              tableHTML += "<tr>" +
                              "<th>순번</th>" +
                              "<th>제목</th>" +
                              "<th>대표자</th>" +
                              "<th>주소지</th>" +
                              "<th>일반전화</th>" +
                              "<th>휴대전화</th>" +
                           "</tr>";

              // 선택된 각 행에 대해 데이터를 추출하여 테이블 행 생성
              $('input.row-checkbox:checked').each(function(){
                  var row = $(this).closest('tr');
                  var tds = row.find('td');
                  var seq = $(tds[1]).text();
                  var title = $(tds[2]).text();
                  var rep = $(tds[3]).text();
                  var addr = $(tds[4]).text();
                  var phone = $(tds[5]).text();
                  var mobile = $(tds[6]).text();
                  tableHTML += "<tr>" +
                                  "<td>" + seq + "</td>" +
                                  "<td>" + title + "</td>" +
                                  "<td>" + rep + "</td>" +
                                  "<td>" + addr + "</td>" +
                                  "<td>" + phone + "</td>" +
                                  "<td>" + mobile + "</td>" +
                               "</tr>";
              });
              tableHTML += "</table>";

              // 첫번째 h1 요소의 outerHTML 추출 (엑셀 문서 상단 제목)
              var titleHTML = $("h1").first().prop("outerHTML");

              // 엑셀에서 인식할 수 있도록 HTML 문서 형태로 감싸기
              var excelHTML = '<html xmlns:o="urn:schemas-microsoft-com:office:office" ' +
                              'xmlns:x="urn:schemas-microsoft-com:office:excel" ' +
                              'xmlns="http://www.w3.org/TR/REC-html40">' +
                              '<head><meta charset="UTF-8"></head><body>' +
                              titleHTML + tableHTML +
                              '</body></html>';

              // Blob 객체 생성
              var blob = new Blob([excelHTML], { type: "application/vnd.ms-excel" });
              var url = URL.createObjectURL(blob);
              var a = document.createElement('a');
              a.href = url;
              // apt_name 변수가 정의되지 않았다면 아래와 같이 기본 파일명("selected_data.xls")을 사용할 수 있습니다.
              const excel_file_name = $('#sel_type').val() == 'realtor' ? "중계사" : "대출상담사";
              a.download = excel_file_name + '.xls';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
          });

          // 전송(확인후) 버튼 클릭 이벤트
          document.getElementById('send-message-pop').addEventListener('click', function() {
            // 전송 유형 확인 (알림톡/문자)
            const sendType = document.querySelector('input[name="send-type"]:checked').value;
            const sendTypeText = sendType === 'kakao' ? '알림톡' : '문자';

            // 모달 제목 설정
            document.getElementById('confirm-modal-title').textContent = `${sendTypeText} 전송 확인`;

            // 전송 목록 설정
            const selectedItems = document.querySelectorAll('.selected-list-item');
            const recipientCount = selectedItems.length;
            const firstRecipient = selectedItems.length > 0 ?
              selectedItems[0].querySelector('span:nth-child(2)').textContent : '';

            let recipientText = firstRecipient;
            if (recipientCount > 1) {
              recipientText += `외 ${recipientCount - 1}명`;
            }
            document.getElementById('confirm-recipients').textContent = recipientText;

            // 메시지 내용 설정
            const title = document.getElementById('message-title').value;
            const content = document.getElementById('message-content').value;

            const formattedMessage = `안녕하세요. ${firstRecipient}님\n` +
                                    `물건 ${title} 요청합니다.\n` +
                                    `${content}\n` +
                                    `잘부탁합니다.\n` +
                                    `감사합니다.`;

            document.getElementById('confirm-message').value = formattedMessage;

            // 첨부 이미지 설정
            const thumbnailList = document.querySelector('.thumbnail-list');
            const confirmThumbnailList = document.getElementById('confirm-thumbnail-list');
            confirmThumbnailList.innerHTML = '';

            if (thumbnailList) {
              const thumbnails = thumbnailList.querySelectorAll('.thumbnail-item img');
              thumbnails.forEach(thumb => {
                const src = thumb.getAttribute('src');
                confirmThumbnailList.innerHTML += `
                  <div class="confirm-thumbnail-item">
                    <img src="${src}" alt="첨부이미지">
                  </div>
                `;
              });
            }

            // 모달 표시
            document.getElementById('confirm-modal').style.display = 'block';
          });

          // 확인 모달 닫기 버튼
          document.querySelector('.confirm-close-btn').addEventListener('click', function() {
            document.getElementById('confirm-modal').style.display = 'none';
          });

          // 확인 모달 전송 버튼
          document.getElementById('confirm-send-btn').addEventListener('click', function() {
            // 실제 전송 로직 실행 (기존 send-message-btn의 로직 재사용)
            document.getElementById('send-message-btn').click();

            // 모달 닫기
            document.getElementById('confirm-modal').style.display = 'none';
          });

    });

  </script>
</head>
<body>
  <h2>
    중개사/대출상담사 검색
    <span id="api-link" style="color: blue; font-size: 25px; text-decoration: underline; cursor: pointer;"></span>
  </h2>
  <div class="search-container">
    <div class="search-input-group">
      <label for="sel_type" style="margin-right:1px;">구분:</label>
      <select id="sel_type" style="margin-right:5px; padding:8px; border:1px solid #ddd; border-radius:4px;">
        <option value="realtor">중개사</option>
        <option value="loaner">상담사</option>
        <option value="lawer">세무사</option>
      </select>
      <input type="text" id="dangiName" placeholder="읍면동을 입력하세요">
      <input type="text" id="locatadd_nm" placeholder="중개소 입력하세요">
      <!-- 건수 표시용 span 추가 -->
<!--      <span id="result-count" style="margin-left:10px; font-weight:bold;">0</span>-->
      <span id="result-count" style="margin-left: auto;">0</span>
      <button class="search-btn" id="search-btn">검색</button>
      <button class="message-btn" id="message-btn">메시지</button>
      <!-- 엑셀 버튼을 이미지 형태로 -->
      <button class="excel-btn" id="download-btn">
        <img src="excel_icon.png" alt="엑셀 저장" style="width:24px; height:24px; vertical-align: middle;">
      </button>
    </div>
  </div>

  <!-- 헤더 (전체 선택 체크박스 포함) -->
  <div id="header-container">
    <span style="flex:0.5;"><input type="checkbox" id="select-all"></span>
    <span style="flex:0.5;">순번</span>
    <span>제목</span>
    <span>대표자</span>
    <span>주소지</span>
    <span>일반전화</span>
    <span>휴대전화</span>
    <span>지도</span>
  </div>

  <div class="table-container">
    <table>
      <tbody id="dataBody"></tbody>
    </table>
    <div id="loading" class="loading-message" style="display: none;">데이터 검색 중입니다...</div>
    <div id="noData" class="no-data-message">데이터를 검색해 주세요.</div>
    <div id="errorMessage" class="error-message" style="display: none; color: red; margin-top: 10px; text-align: center"></div>

    <!-- 메시지 팝업 (테이블 컨테이너 내부 중앙) -->
    <div id="message-popup">
      <span class="close-btn">&times;</span>
      <div class="popup-header">
        <h3>메시지보내기</h3>
        <span class="popup-count">(0건)</span>
      </div>
      <!-- 선택 목록 (순번, 대표자, 휴대전화) -->
      <div id="selected-list-container"></div>

      <!-- 전송방식 선택 (알림톡 / 문자) -->
      <div class="send-type" style="display: flex; align-items: center; margin-bottom: 10px;">
        <label><input type="radio" name="send-type" value="kakao" checked> 알림톡</label>
        <label style="margin-left: 15px;"><input type="radio" name="send-type" value="sms"> 뿌리오 문자</label>
        <label style="margin-left: 15px;"><input type="radio" name="send-type" value="naver_mms"> 네이버 문자</label>
        <!--
        <select id="send_tool_type" style="margin-left: auto; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <option value="kakao">알림톡</option>
          <option value="sms">문자</option>
        </select>
        -->
        <!-- sms_type 드롭다운 오른쪽에 배치 -->
        <select id="sms_type" style="margin-left: auto; padding:8px; border:1px solid #ddd; border-radius:4px;">
          <option value="sms">일반</option>
          <option value="house">주택</option>
          <option value="sanga">상가</option>
        </select>
      </div>

      <!-- 로그인 정보 입력 (한 줄에 로그인 ID와 패스워드) -->
      <div class="login-info" id="login-info" style="display: none; margin-bottom: 10px;">
        <input type="text" id="login-id" placeholder="로그인 ID" style="flex: 1; margin-right: 4%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="logphone">
        <input type="password" id="login-password" placeholder="패스워드" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="ekqkek#$0">
      </div>
      <!-- 추가 입력 폼 -->
      <div class="add-entry">
        <label>이름: <input type="text" id="new-name"></label>
        <label>전화번호: <input type="text" id="new-phone" placeholder="010-1234-5678"></label>
        <button id="add-entry-btn">추가</button>
      </div>
      <!-- 제목 입력 -->
      <div class="title-input" style="margin-bottom: 10px;">
        <input type="text" id="message-title" placeholder="제목을 입력하세요" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" value="주택및 상가매도의뢰합니다.">
      </div>
      <!-- 메시지 입력 영역 -->
      <textarea id="message-content" placeholder="전송할 메시지를 입력하세요"></textarea>
      <!-- 첨부파일 영역 -->
      <div class="attachment-container">
        <input type="file" id="file-input" accept="image/*" multiple>
        <div class="thumbnail-slider">
          <div class="thumb-nav left">&#9664;</div>
          <div class="thumbnail-list"></div>
          <div class="thumb-nav right">&#9654;</div>
        </div>
      </div>
      <button id="send-message-btn">전송</button>
      <button id="send-message-pop">전송(확인후)</button>
    </div>
  </div>

  <!-- 이미지 팝업 (썸네일 클릭 시) -->
  <div id="image-popup">
    <img src="" alt="첨부 이미지">
  </div>

  <!-- 메시지 전송 처리 중 로딩 메시지 (초기에는 숨김) -->
  <div id="sending-message" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: rgba(0,0,0,0.7); color: white; font-size: 20px; border-radius: 8px; z-index: 3000;">
    메시지전송처리중..
  </div>

  <!-- 확인 모달 창 -->
  <div id="confirm-modal">
    <div class="confirm-modal-header">
      <h3 id="confirm-modal-title">알림톡 전송 확인</h3>
    </div>

    <div class="confirm-modal-content">
      <div class="confirm-info-row">
        <label>전송목록:</label>
        <div id="confirm-recipients">강종철외 15명</div>
      </div>
      <div class="confirm-info-row">
        <textarea id="confirm-message" readonly>안녕하세요. 강종철님
물건 [제목] 요청합니다.
[내용]
잘부탁합니다.
감사합니다.</textarea>
      </div>

      <div class="confirm-thumbnail-slider">
        <div class="confirm-thumbnail-list" id="confirm-thumbnail-list">
          <!-- 썸네일이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>
    </div>

    <div class="confirm-modal-footer">
      <button class="confirm-send-btn" id="confirm-send-btn">전송</button>
      <button class="confirm-close-btn">닫기</button>
    </div>
  </div>
</body>
</html>
